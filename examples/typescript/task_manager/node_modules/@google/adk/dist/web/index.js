/**
  * @license
  * Copyright 2025 Google LLC
  * SPDX-License-Identifier: Apache-2.0
  */

var Qn=Object.defineProperty,Wn=Object.defineProperties;var Xn=Object.getOwnPropertyDescriptors;var Ft=Object.getOwnPropertySymbols;var Hn=Object.prototype.hasOwnProperty,Jn=Object.prototype.propertyIsEnumerable;var Oe=(n,e)=>(e=Symbol[n])?e:Symbol.for("Symbol."+n);var Dt=(n,e,t)=>e in n?Qn(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,x=(n,e)=>{for(var t in e||(e={}))Hn.call(e,t)&&Dt(n,t,e[t]);if(Ft)for(var t of Ft(e))Jn.call(e,t)&&Dt(n,t,e[t]);return n},ee=(n,e)=>Wn(n,Xn(e));var f=function(n,e){this[0]=n,this[1]=e},C=(n,e,t)=>{var o=(s,c,a,l)=>{try{var u=t[s](c),d=(c=u.value)instanceof f,m=u.done;Promise.resolve(d?c[0]:c).then(g=>d?o(s==="return"?s:"next",c[1]?{done:g.done,value:g.value}:g,a,l):a({value:g,done:m})).catch(g=>o("throw",g,a,l))}catch(g){l(g)}},r=s=>i[s]=c=>new Promise((a,l)=>o(s,c,a,l)),i={};return t=t.apply(n,e),i[Oe("asyncIterator")]=()=>i,r("next"),r("throw"),r("return"),i};var b=(n,e,t)=>(e=n[Oe("asyncIterator")])?e.call(n):(n=n[Oe("iterator")](),e={},t=(o,r)=>(r=n[o])&&(e[o]=i=>new Promise((s,c,a)=>(i=r.call(n,i),a=i.done,Promise.resolve(i.value).then(l=>s({value:l,done:a}),c)))),t("next"),t("return"),e);var Ne=class{constructor(e={}){this.task=e.task,this.stream=e.stream}};import{trace as Kt}from"@opentelemetry/api";function G(n={}){return x({stateDelta:{},artifactDelta:{},requestedAuthConfigs:{},requestedToolConfirmations:{}},n)}function Gt(n,e){let t=G();e&&Object.assign(t,e);for(let o of n)o&&(o.stateDelta&&Object.assign(t.stateDelta,o.stateDelta),o.artifactDelta&&Object.assign(t.artifactDelta,o.artifactDelta),o.requestedAuthConfigs&&Object.assign(t.requestedAuthConfigs,o.requestedAuthConfigs),o.requestedToolConfirmations&&Object.assign(t.requestedToolConfirmations,o.requestedToolConfirmations),o.skipSummarization!==void 0&&(t.skipSummarization=o.skipSummarization),o.transferToAgent!==void 0&&(t.transferToAgent=o.transferToAgent),o.escalate!==void 0&&(t.escalate=o.escalate));return t}function R(n={}){return ee(x({},n),{id:n.id||Fe(),invocationId:n.invocationId||"",author:n.author,actions:n.actions||G(),longRunningToolIds:n.longRunningToolIds||[],branch:n.branch,timestamp:n.timestamp||Date.now()})}function te(n){return n.actions.skipSummarization||n.longRunningToolIds&&n.longRunningToolIds.length>0?!0:k(n).length===0&&B(n).length===0&&!n.partial&&!qt(n)}function k(n){let e=[];if(n.content&&n.content.parts)for(let t of n.content.parts)t.functionCall&&e.push(t.functionCall);return e}function B(n){let e=[];if(n.content&&n.content.parts)for(let t of n.content.parts)t.functionResponse&&e.push(t.functionResponse);return e}function qt(n){var e;return n.content&&((e=n.content.parts)!=null&&e.length)?n.content.parts[n.content.parts.length-1].codeExecutionResult!==void 0:!1}function eo(n){var e;return(e=n.content)!=null&&e.parts?n.content.parts.map(t=>{var o;return(o=t.text)!=null?o:""}).join(""):""}var $t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";function Fe(){let n="";for(let e=0;e<8;e++)n+=$t[Math.floor(Math.random()*$t.length)];return n}var T=class{constructor(e={},t={}){this.value=e;this.delta=t}get(e,t){return e in this.delta?this.delta[e]:e in this.value?this.value[e]:t}set(e,t){this.value[e]=t,this.delta[e]=t}has(e){return e in this.value||e in this.delta}hasDelta(){return Object.keys(this.delta).length>0}update(e){this.delta=x(x({},this.delta),e),this.value=x(x({},this.value),e)}toRecord(){return x(x({},this.value),this.delta)}};T.APP_PREFIX="app:",T.USER_PREFIX="user:",T.TEMP_PREFIX="temp:";var _=class{constructor(e){this.invocationContext=e}get userContent(){return this.invocationContext.userContent}get invocationId(){return this.invocationContext.invocationId}get agentName(){return this.invocationContext.agent.name}get state(){return new T(this.invocationContext.session.state,{})}};var M=class extends _{constructor({invocationContext:e,eventActions:t}){super(e),this.eventActions=t||G(),this._state=new T(e.session.state,this.eventActions.stateDelta)}get state(){return this._state}loadArtifact(e,t){if(!this.invocationContext.artifactService)throw new Error("Artifact service is not initialized.");return this.invocationContext.artifactService.loadArtifact({appName:this.invocationContext.appName,userId:this.invocationContext.userId,sessionId:this.invocationContext.session.id,filename:e,version:t})}async saveArtifact(e,t){if(!this.invocationContext.artifactService)throw new Error("Artifact service is not initialized.");let o=await this.invocationContext.artifactService.saveArtifact({appName:this.invocationContext.appName,userId:this.invocationContext.userId,sessionId:this.invocationContext.session.id,filename:e,artifact:t});return this.eventActions.artifactDelta[e]=o,o}};function ve(){return typeof window<"u"}var Ce="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx";function ne(){let n="";for(let e=0;e<Ce.length;e++){let t=Math.random()*16|0;Ce[e]==="x"?n+=t.toString(16):Ce[e]==="y"?n+=(t&3|8).toString(16):n+=Ce[e]}return n}function Ut(n){return ve()?window.atob(n):Buffer.from(n,"base64").toString()}var De=class{constructor(){this.numberOfLlmCalls=0}incrementAndEnforceLlmCallsLimit(e){if(this.numberOfLlmCalls++,e&&e.maxLlmCalls>0&&this.numberOfLlmCalls>e.maxLlmCalls)throw new Error("Max number of llm calls limit of ".concat(e.maxLlmCalls," exceeded"))}},q=class{constructor(e){this.invocationCostManager=new De;this.artifactService=e.artifactService,this.sessionService=e.sessionService,this.memoryService=e.memoryService,this.invocationId=e.invocationId,this.branch=e.branch,this.agent=e.agent,this.userContent=e.userContent,this.session=e.session,this.endInvocation=e.endInvocation||!1,this.transcriptionCache=e.transcriptionCache,this.runConfig=e.runConfig,this.liveRequestQueue=e.liveRequestQueue,this.activeStreamingTools=e.activeStreamingTools,this.pluginManager=e.pluginManager}get appName(){return this.session.appName}get userId(){return this.session.userId}incrementLlmCallCount(){this.invocationCostManager.incrementAndEnforceLlmCallsLimit(this.runConfig)}};function jt(){return"e-".concat(ne())}var Ge=Symbol.for("google.adk.baseAgent");function to(n){return typeof n=="object"&&n!==null&&Ge in n&&n[Ge]===!0}var Zt;Zt=Ge;var F=class{constructor(e){this[Zt]=!0;this.name=no(e.name),this.description=e.description,this.parentAgent=e.parentAgent,this.subAgents=e.subAgents||[],this.rootAgent=ro(this),this.beforeAgentCallback=Vt(e.beforeAgentCallback),this.afterAgentCallback=Vt(e.afterAgentCallback),this.setParentAgentForSubAgents()}runAsync(e){return C(this,null,function*(){let t=Kt.getTracer("gcp.vertex.agent").startSpan("agent_run [".concat(this.name,"]"));try{let c=this.createInvocationContext(e),a=yield new f(this.handleBeforeAgentCallback(c));if(a&&(yield a),c.endInvocation)return;try{for(var o=b(this.runAsyncImpl(c)),r,i,s;r=!(i=yield new f(o.next())).done;r=!1){let u=i.value;yield u}}catch(i){s=[i]}finally{try{r&&(i=o.return)&&(yield new f(i.call(o)))}finally{if(s)throw s[0]}}if(c.endInvocation)return;let l=yield new f(this.handleAfterAgentCallback(c));l&&(yield l)}finally{t.end()}})}runLive(e){return C(this,null,function*(){let t=Kt.getTracer("gcp.vertex.agent").startSpan("agent_run [".concat(this.name,"]"));try{throw new Error("Live mode is not implemented yet.")}finally{t.end()}})}findAgent(e){return this.name===e?this:this.findSubAgent(e)}findSubAgent(e){for(let t of this.subAgents){let o=t.findAgent(e);if(o)return o}}createInvocationContext(e){return new q(ee(x({},e),{agent:this}))}async handleBeforeAgentCallback(e){if(this.beforeAgentCallback.length===0)return;let t=new M({invocationContext:e});for(let o of this.beforeAgentCallback){let r=await o(t);if(r)return e.endInvocation=!0,R({invocationId:e.invocationId,author:this.name,branch:e.branch,content:r,actions:t.eventActions})}if(t.state.hasDelta())return R({invocationId:e.invocationId,author:this.name,branch:e.branch,actions:t.eventActions})}async handleAfterAgentCallback(e){if(this.afterAgentCallback.length===0)return;let t=new M({invocationContext:e});for(let o of this.afterAgentCallback){let r=await o(t);if(r)return R({invocationId:e.invocationId,author:this.name,branch:e.branch,content:r,actions:t.eventActions})}if(t.state.hasDelta())return R({invocationId:e.invocationId,author:this.name,branch:e.branch,actions:t.eventActions})}setParentAgentForSubAgents(){for(let e of this.subAgents){if(e.parentAgent)throw new Error('Agent "'.concat(e.name,'" already has a parent agent, current parent: "').concat(e.parentAgent.name,'", trying to add: "').concat(this.name,'"'));e.parentAgent=this}}};function no(n){if(!oo(n))throw new Error('Found invalid agent name: "'.concat(n,'". Agent name must be a valid identifier. It should start with a letter (a-z, A-Z) or an underscore (_), and can only contain letters, digits (0-9), and underscores.'));if(n==="user")throw new Error("Agent name cannot be 'user'. 'user' is reserved for end-user's input.");return n}function oo(n){return new RegExp("^[\\p{ID_Start}$_][\\p{ID_Continue}$_]*$","u").test(n)}function ro(n){for(;n.parentAgent;)n=n.parentAgent;return n}function Vt(n){return n?Array.isArray(n)?n:[n]:[]}var $=class{},$e=class{};import{createUserContent as lo}from"@google/genai";import{isEmpty as Yt}from"lodash-es";var ce=class{constructor(e){this.authConfig=e}getAuthResponse(e){let t="temp:"+this.authConfig.credentialKey;return e.get(t)}generateAuthRequest(){var t,o;let e=this.authConfig.authScheme.type;if(!["oauth2","openIdConnect"].includes(e))return this.authConfig;if((o=(t=this.authConfig.exchangedAuthCredential)==null?void 0:t.oauth2)!=null&&o.authUri)return this.authConfig;if(!this.authConfig.rawAuthCredential)throw new Error("Auth Scheme ".concat(e," requires authCredential."));if(!this.authConfig.rawAuthCredential.oauth2)throw new Error("Auth Scheme ".concat(e," requires oauth2 in authCredential."));if(this.authConfig.rawAuthCredential.oauth2.authUri)return{credentialKey:this.authConfig.credentialKey,authScheme:this.authConfig.authScheme,rawAuthCredential:this.authConfig.rawAuthCredential,exchangedAuthCredential:this.authConfig.rawAuthCredential};if(!this.authConfig.rawAuthCredential.oauth2.clientId||!this.authConfig.rawAuthCredential.oauth2.clientSecret)throw new Error("Auth Scheme ".concat(e," requires both clientId and clientSecret in authCredential.oauth2."));return{credentialKey:this.authConfig.credentialKey,authScheme:this.authConfig.authScheme,rawAuthCredential:this.authConfig.rawAuthCredential,exchangedAuthCredential:this.generateAuthUri()}}generateAuthUri(){return this.authConfig.rawAuthCredential}};var V=class{constructor({hint:e,confirmed:t,payload:o}){this.hint=e!=null?e:"",this.confirmed=t,this.payload=o}};var K=class extends M{constructor(e){super(e),this.functionCallId=e.functionCallId,this.toolConfirmation=e.toolConfirmation}get actions(){return this.eventActions}requestCredential(e){if(!this.functionCallId)throw new Error("functionCallId is not set.");let t=new ce(e);this.eventActions.requestedAuthConfigs[this.functionCallId]=t.generateAuthRequest()}getAuthResponse(e){return new ce(e).getAuthResponse(this.state)}listArtifacts(){if(!this.invocationContext.artifactService)throw new Error("Artifact service is not initialized.");return this.invocationContext.artifactService.listArtifactKeys({appName:this.invocationContext.session.appName,userId:this.invocationContext.session.userId,sessionId:this.invocationContext.session.id})}searchMemory(e){if(!this.invocationContext.memoryService)throw new Error("Memory service is not initialized.");return this.invocationContext.memoryService.searchMemory({appName:this.invocationContext.session.appName,userId:this.invocationContext.session.userId,query:e})}requestConfirmation({hint:e,payload:t}){if(!this.functionCallId)throw new Error("functionCallId is not set.");this.eventActions.requestedToolConfirmations[this.functionCallId]=new V({hint:e,confirmed:!1,payload:t})}};var zt=(r=>(r[r.DEBUG=0]="DEBUG",r[r.INFO=1]="INFO",r[r.WARN=2]="WARN",r[r.ERROR=3]="ERROR",r))(zt||{}),oe=1;function io(n){oe=n}var qe=class{log(e,...t){if(!(e<oe))switch(e){case 0:this.debug(...t);break;case 1:this.info(...t);break;case 2:this.warn(...t);break;case 3:this.error(...t);break;default:throw new Error("Unsupported log level: ".concat(e))}}debug(...e){oe>0||console.debug(ye(0),...e)}info(...e){oe>1||console.info(ye(1),...e)}warn(...e){oe>2||console.warn(ye(2),...e)}error(...e){oe>3||console.error(ye(3),...e)}},so={0:"DEBUG",1:"INFO",2:"WARN",3:"ERROR"},ao={0:"\x1B[34m",1:"\x1B[32m",2:"\x1B[33m",3:"\x1B[31m"},co="\x1B[0m";function ye(n){return"".concat(ao[n],"[ADK ").concat(so[n],"]:").concat(co)}var y=new qe;var Ue="adk-",Ae="adk_request_credential",re="adk_request_confirmation",uo={handleFunctionCallList:xe,generateAuthEvent:Ke,generateRequestConfirmationEvent:Ve};function je(){return"".concat(Ue).concat(ne())}function Qt(n){let e=k(n);if(e)for(let t of e)t.id||(t.id=je())}function Wt(n){if(n&&n.parts)for(let e of n.parts)e.functionCall&&e.functionCall.id&&e.functionCall.id.startsWith(Ue)&&(e.functionCall.id=void 0),e.functionResponse&&e.functionResponse.id&&e.functionResponse.id.startsWith(Ue)&&(e.functionResponse.id=void 0)}function Xt(n,e){let t=new Set;for(let o of n)o.name&&o.name in e&&e[o.name].isLongRunning&&o.id&&t.add(o.id);return t}function Ke(n,e){var r;if(!((r=e.actions)!=null&&r.requestedAuthConfigs)||Yt(e.actions.requestedAuthConfigs))return;let t=[],o=new Set;for(let[i,s]of Object.entries(e.actions.requestedAuthConfigs)){let c={name:Ae,args:{function_call_id:i,auth_config:s},id:je()};o.add(c.id),t.push({functionCall:c})}return R({invocationId:n.invocationId,author:n.agent.name,branch:n.branch,content:{parts:t,role:e.content.role},longRunningToolIds:Array.from(o)})}function Ve({invocationContext:n,functionCallEvent:e,functionResponseEvent:t}){var s,c;if(!((s=t.actions)!=null&&s.requestedToolConfirmations)||Yt(t.actions.requestedToolConfirmations))return;let o=[],r=new Set,i=k(e);for(let[a,l]of Object.entries(t.actions.requestedToolConfirmations)){let u=(c=i.find(m=>m.id===a))!=null?c:void 0;if(!u)continue;let d={name:re,args:{originalFunctionCall:u,toolConfirmation:l},id:je()};r.add(d.id),o.push({functionCall:d})}return R({invocationId:n.invocationId,author:n.agent.name,branch:n.branch,content:{parts:o,role:t.content.role},longRunningToolIds:Array.from(r)})}async function fo(n,e,t){return y.debug("callToolAsync ".concat(n.name)),await n.runAsync({args:e,toolContext:t})}async function Ht({invocationContext:n,functionCallEvent:e,toolsDict:t,beforeToolCallbacks:o,afterToolCallbacks:r,filters:i,toolConfirmationDict:s}){let c=k(e);return await xe({invocationContext:n,functionCalls:c,toolsDict:t,beforeToolCallbacks:o,afterToolCallbacks:r,filters:i,toolConfirmationDict:s})}async function xe({invocationContext:n,functionCalls:e,toolsDict:t,beforeToolCallbacks:o,afterToolCallbacks:r,filters:i,toolConfirmationDict:s}){var u;let c=[],a=e.filter(d=>!i||d.id&&i.has(d.id));for(let d of a){let m;s&&d.id&&(m=s[d.id]);let{tool:g,toolContext:A}=po({invocationContext:n,functionCall:d,toolsDict:t,toolConfirmation:m});y.debug("execute_tool ".concat(g.name));let v=(u=d.args)!=null?u:{},h=null,p;if(h=await n.pluginManager.runBeforeToolCallback({tool:g,toolArgs:v,toolContext:A}),h==null){for(let S of o)if(h=await S({tool:g,args:v,context:A}),h)break}if(h==null)try{h=await fo(g,v,A)}catch(S){if(S instanceof Error){let L=await n.pluginManager.runOnToolErrorCallback({tool:g,toolArgs:v,toolContext:A,error:S});L?h=L:p=S.message}else p=S}let E=await n.pluginManager.runAfterToolCallback({tool:g,toolArgs:v,toolContext:A,result:h});if(E==null){for(let S of r)if(E=await S({tool:g,args:v,context:A,response:h}),E)break}if(E!=null&&(h=E),g.isLongRunning&&!h)continue;p?h={error:p}:(typeof h!="object"||h==null)&&(h={result:h});let N=R({invocationId:n.invocationId,author:n.agent.name,content:lo({functionResponse:{id:A.functionCallId,name:g.name,response:h}}),actions:A.actions,branch:n.branch});y.debug("traceToolCall",{tool:g.name,args:v,functionResponseEvent:N.id}),c.push(N)}if(!c.length)return null;let l=mo(c);return c.length>1&&(y.debug("execute_tool (merged)"),y.debug("traceMergedToolCalls",{responseEventId:l.id,functionResponseEvent:l.id})),l}function po({invocationContext:n,functionCall:e,toolsDict:t,toolConfirmation:o}){if(!e.name||!(e.name in t))throw new Error("Function ".concat(e.name," is not found in the toolsDict."));let r=new K({invocationContext:n,functionCallId:e.id||void 0,toolConfirmation:o});return{tool:t[e.name],toolContext:r}}function mo(n){if(!n.length)throw new Error("No function response events provided.");if(n.length===1)return n[0];let e=[];for(let i of n)i.content&&i.content.parts&&e.push(...i.content.parts);let t=n[0],o=n.map(i=>i.actions||{}),r=Gt(o);return R({author:t.author,branch:t.branch,content:{role:"user",parts:e},actions:r,timestamp:t.timestamp})}var Ze=class{constructor(){this.queue=[];this.resolveFnFifoQueue=[];this.isClosed=!1}send(e){if(this.isClosed)throw new Error("Cannot send to a closed queue.");this.resolveFnFifoQueue.length>0?this.resolveFnFifoQueue.shift()(e):this.queue.push(e)}async get(){return this.queue.length>0?this.queue.shift():this.isClosed?{close:!0}:new Promise(e=>{this.resolveFnFifoQueue.push(e)})}close(){if(this.isClosed)return;for(this.isClosed=!0;this.resolveFnFifoQueue.length>0&&this.queue.length>0;){let t=this.resolveFnFifoQueue.shift(),o=this.queue.shift();t(o)}let e={close:!0};for(;this.resolveFnFifoQueue.length>0;)this.resolveFnFifoQueue.shift()(e)}sendContent(e){this.send({content:e})}sendRealtime(e){this.send({blob:e})}sendActivityStart(){this.send({activityStart:{}})}sendActivityEnd(){this.send({activityEnd:{}})}[Symbol.asyncIterator](){return C(this,null,function*(){for(;;){let e=yield new f(this.get());if(yield e,e.close)break}})}};import{cloneDeep as Sn}from"lodash-es";import{z as Rn}from"zod";var ze=Symbol.for("google.adk.baseCodeExecutor");function Ee(n){return typeof n=="object"&&n!==null&&ze in n&&n[ze]===!0}var Jt;Jt=ze;var le=class{constructor(){this[Jt]=!0;this.optimizeDataFile=!1;this.stateful=!1;this.errorRetryAttempts=2;this.codeBlockDelimiters=[["```tool_code\n","\n```"],["```python\n","\n```"]];this.executionResultDelimiters=["```tool_output\n","\n```"]}};var go="^projects/[^/]+/locations/[^/]+/publishers/[^/]+/models/(.+)$";function Ye(n){let e=n.match(go);return e?e[1]:n}function en(n){return Ye(n).startsWith("gemini-")}function ho(n){if(!/^\d+(\.\d+)*$/.test(n))return{valid:!1,major:0,minor:0,patch:0};let e=n.split(".").map(t=>parseInt(t,10));return{valid:!0,major:e[0],minor:e.length>1?e[1]:0,patch:e.length>2?e[2]:0}}function tn(n){return Ye(n).startsWith("gemini-1")}function ue(n){if(!n)return!1;let e=Ye(n);if(!e.startsWith("gemini-"))return!1;let t=e.slice(7).split("-",1)[0],o=ho(t);return o.valid&&o.major>=2}var Qe=Symbol.for("google.adk.builtInCodeExecutor");function de(n){return typeof n=="object"&&n!==null&&Qe in n&&n[Qe]===!0}var nn,on,fe=class extends(on=le,nn=Qe,on){constructor(){super(...arguments);this[nn]=!0}executeCode(t){return Promise.resolve({stdout:"",stderr:"",outputFiles:[]})}processLlmRequest(t){if(t.model&&ue(t.model)){t.config=t.config||{},t.config.tools=t.config.tools||[],t.config.tools.push({codeExecution:{}});return}throw new Error("Gemini code execution tool is not supported for model ".concat(t.model))}};import{Language as Co,Outcome as rn}from"@google/genai";import{cloneDeep as vo}from"lodash-es";function sn(n,e){var u;if(!((u=n.parts)!=null&&u.length))return"";for(let d=0;d<n.parts.length;d++){let m=n.parts[d];if(m.executableCode&&(d===n.parts.length-1||!n.parts[d+1].codeExecutionResult))return n.parts=n.parts.slice(0,d+1),m.executableCode.code}let t=n.parts.filter(d=>d.text);if(!t.length)return"";let o=vo(t[0]),r=t.map(d=>d.text).join("\n"),i=e.map(d=>d[0]).join("|"),s=e.map(d=>d[1]).join("|"),c=new RegExp("?<prefix>.*?)(".concat(i,")(?<codeStr>.*?)(").concat(s,")(?<suffix>.*?)$"),"s").exec(r),{prefix:a,codeStr:l}=(c==null?void 0:c.groups)||{};return l?(n.parts=[],a&&(o.text=a,n.parts.push(o)),n.parts.push(We(l)),l):""}function We(n){return{text:n,executableCode:{code:n,language:Co.PYTHON}}}function an(n){if(n.stderr)return{text:n.stderr,codeExecutionResult:{outcome:rn.OUTCOME_FAILED}};let e=[];return(n.stdout||!n.outputFiles)&&e.push("Code execution result:\n".concat(n.stdout,"\n")),n.outputFiles&&e.push("Saved artifacts:\n"+n.outputFiles.map(t=>t.name).join(", ")),{text:e.join("\n\n"),codeExecutionResult:{outcome:rn.OUTCOME_OK}}}function cn(n,e,t){var r;if(!((r=n.parts)!=null&&r.length))return;let o=n.parts[n.parts.length-1];o.executableCode?n.parts[n.parts.length-1]={text:e[0]+o.executableCode.code+e[1]}:n.parts.length==1&&o.codeExecutionResult&&(n.parts[n.parts.length-1]={text:t[0]+o.codeExecutionResult.output+t[1]},n.role="user")}import{cloneDeep as yo}from"lodash-es";var Xe="_code_execution_context",He="execution_session_id",Z="processed_input_files",z="_code_executor_input_files",Y="_code_executor_error_counts",Je="_code_execution_results",pe=class{constructor(e){this.sessionState=e;var t;this.context=(t=e.get(Xe))!=null?t:{},this.sessionState=e}getStateDelta(){return{[Xe]:yo(this.context)}}getExecutionId(){if(He in this.context)return this.context[He]}setExecutionId(e){this.context[He]=e}getProcessedFileNames(){return Z in this.context?this.context[Z]:[]}addProcessedFileNames(e){Z in this.context||(this.context[Z]=[]),this.context[Z].push(...e)}getInputFiles(){return z in this.sessionState?this.sessionState.get(z):[]}addInputFiles(e){z in this.sessionState||this.sessionState.set(z,[]),this.sessionState.get(z).push(...e)}clearInputFiles(){z in this.sessionState&&this.sessionState.set(z,[]),Z in this.context&&(this.context[Z]=[])}getErrorCount(e){return Y in this.sessionState&&this.sessionState.get(Y)[e]||0}incrementErrorCount(e){Y in this.sessionState||this.sessionState.set(Y,{}),this.sessionState.get(Y)[e]=this.getErrorCount(e)+1}resetErrorCount(e){if(!(Y in this.sessionState))return;let t=this.sessionState.get(Y);e in t&&delete t[e]}updateCodeExecutionResult({invocationId:e,code:t,resultStdout:o,resultStderr:r}){Je in this.sessionState||this.sessionState.set(Je,{});let i=this.sessionState.get(Je);e in i||(i[e]=[]),i[e].push({code:t,resultStdout:o,resultStderr:r,timestamp:Date.now()})}getCodeExecutionContext(e){return this.sessionState.get(Xe)||{}}};var et="0.2.5";var Ao="google-adk",xo="gl-typescript",Eo="remote_reasoning_engine",bo="GOOGLE_CLOUD_AGENT_ENGINE_ID";function To(){let n="".concat(Ao,"/").concat(et);!ve()&&process.env[bo]&&(n="".concat(n,"+").concat(Eo));let e="".concat(xo,"/").concat(ve()?window.navigator.userAgent:process.version);return[n,e]}function ln(){return To()}var tt=Symbol.for("google.adk.baseModel");function nt(n){return typeof n=="object"&&n!==null&&tt in n&&n[tt]===!0}var un;un=tt;var ie=class{constructor({model:e}){this[un]=!0;this.model=e}get trackingHeaders(){let t=ln().join(" ");return{"x-goog-api-client":t,"user-agent":t}}maybeAppendUserContent(e){var t;e.contents.length===0&&e.contents.push({role:"user",parts:[{text:"Handle the requests as specified in the System Instruction."}]}),((t=e.contents[e.contents.length-1])==null?void 0:t.role)!=="user"&&e.contents.push({role:"user",parts:[{text:"Continue processing previous requests as instructed. Exit or provide a summary if no more outputs are needed."}]})}};ie.supportedModels=[];function me(n,e){n.config||(n.config={});let t=e.join("\n\n");n.config.systemInstruction?n.config.systemInstruction+="\n\n"+t:n.config.systemInstruction=t}function fn(n,e){n.config||(n.config={}),n.config.responseSchema=e,n.config.responseMimeType="application/json"}import{createPartFromText as pn,FinishReason as Ro,GoogleGenAI as rt}from"@google/genai";var be=(t=>(t.VERTEX_AI="VERTEX_AI",t.GEMINI_API="GEMINI_API",t))(be||{});function dn(){return So("GOOGLE_GENAI_USE_VERTEXAI")?"VERTEX_AI":"GEMINI_API"}function So(n){if(!process.env)return!1;let e=(process.env[n]||"").toLowerCase();return["true","1"].includes(n.toLowerCase())}var Te=class{constructor(e){this.geminiSession=e}async sendHistory(e){let t=e.filter(o=>{var r;return o.parts&&((r=o.parts[0])==null?void 0:r.text)});t.length>0?this.geminiSession.sendClientContent({turns:t,turnComplete:t[t.length-1].role==="user"}):y.info("no content is sent")}async sendContent(e){if(!e.parts)throw new Error("Content must have parts.");if(e.parts[0].functionResponse){let t=e.parts.map(o=>o.functionResponse).filter(o=>!!o);y.debug("Sending LLM function response:",t),this.geminiSession.sendToolResponse({functionResponses:t})}else y.debug("Sending LLM new content",e),this.geminiSession.sendClientContent({turns:[e],turnComplete:!0})}async sendRealtime(e){y.debug("Sending LLM Blob:",e),this.geminiSession.sendRealtimeInput({media:e})}buildFullTextResponse(e){return{content:{role:"model",parts:[{text:e}]}}}receive(){return C(this,null,function*(){throw new Error("Not Implemented.")})}async close(){this.geminiSession.close()}};function ot(n){var t;let e=n.usageMetadata;if(n.candidates&&n.candidates.length>0){let o=n.candidates[0];return(t=o.content)!=null&&t.parts&&o.content.parts.length>0?{content:o.content,groundingMetadata:o.groundingMetadata,usageMetadata:e,finishReason:o.finishReason}:{errorCode:o.finishReason,errorMessage:o.finishMessage,usageMetadata:e,finishReason:o.finishReason}}return n.promptFeedback?{errorCode:n.promptFeedback.blockReason,errorMessage:n.promptFeedback.blockReasonMessage,usageMetadata:e}:{errorCode:"UNKNOWN_ERROR",errorMessage:"Unknown error.",usageMetadata:e}}var se=class extends ie{constructor({model:e,apiKey:t,vertexai:o,project:r,location:i,headers:s}){e||(e="gemini-2.5-flash"),super({model:e}),this.project=r,this.location=i,this.apiKey=t,this.headers=s;let c=typeof process=="object";if(this.vertexai=!!o,!this.vertexai&&c){let a=process.env.GOOGLE_GENAI_USE_VERTEXAI;a&&(this.vertexai=a.toLowerCase()==="true"||a==="1")}if(this.vertexai){if(c&&!this.project&&(this.project=process.env.GOOGLE_CLOUD_PROJECT),c&&!this.location&&(this.location=process.env.GOOGLE_CLOUD_LOCATION),!this.project)throw new Error("VertexAI project must be provided via constructor or GOOGLE_CLOUD_PROJECT environment variable.");if(!this.location)throw new Error("VertexAI location must be provided via constructor or GOOGLE_CLOUD_LOCATION environment variable.")}else if(!this.apiKey&&c&&(this.apiKey=process.env.GOOGLE_GENAI_API_KEY||process.env.GEMINI_API_KEY),!this.apiKey)throw new Error("API key must be provided via constructor or GOOGLE_GENAI_API_KEY or GEMINI_API_KEY environment variable.")}generateContentAsync(e,t=!1){return C(this,null,function*(){var o,r,i,s,d,m,g;if(this.preprocessRequest(e),this.maybeAppendUserContent(e),y.info("Sending out request, model: ".concat(e.model,", backend: ").concat(this.apiBackend,", stream: ").concat(t)),(o=e.config)!=null&&o.httpOptions&&(e.config.httpOptions.headers=x(x({},e.config.httpOptions.headers),this.trackingHeaders)),t){let A=yield new f(this.apiClient.models.generateContentStream({model:(r=e.model)!=null?r:this.model,contents:e.contents,config:e.config})),v="",h="",p,E;try{for(var c=b(A),a,l,u;a=!(l=yield new f(c.next())).done;a=!1){let N=l.value;E=N;let S=ot(N);p=S.usageMetadata;let L=(s=(i=S.content)==null?void 0:i.parts)==null?void 0:s[0];if(L!=null&&L.text)"thought"in L&&L.thought?v+=L.text:h+=L.text,S.partial=!0;else if((v||h)&&(!L||!L.inlineData)){let Me=[];v&&Me.push({text:v,thought:!0}),h&&Me.push(pn(h)),yield{content:{role:"model",parts:Me},usageMetadata:S.usageMetadata},v="",h=""}yield S}}catch(l){u=[l]}finally{try{a&&(l=c.return)&&(yield new f(l.call(c)))}finally{if(u)throw u[0]}}if((h||v)&&((m=(d=E==null?void 0:E.candidates)==null?void 0:d[0])==null?void 0:m.finishReason)===Ro.STOP){let N=[];v&&N.push({text:v,thought:!0}),h&&N.push({text:h}),yield{content:{role:"model",parts:N},usageMetadata:p}}}else{let A=yield new f(this.apiClient.models.generateContent({model:(g=e.model)!=null?g:this.model,contents:e.contents,config:e.config}));yield ot(A)}})}get apiClient(){if(this._apiClient)return this._apiClient;let e=x(x({},this.trackingHeaders),this.headers);return this.vertexai?this._apiClient=new rt({vertexai:this.vertexai,project:this.project,location:this.location,httpOptions:{headers:e}}):this._apiClient=new rt({apiKey:this.apiKey,httpOptions:{headers:e}}),this._apiClient}get apiBackend(){return this._apiBackend||(this._apiBackend=this.apiClient.vertexai?"VERTEX_AI":"GEMINI_API"),this._apiBackend}get liveApiVersion(){return this._liveApiVersion||(this._liveApiVersion=this.apiBackend==="VERTEX_AI"?"v1beta1":"v1alpha"),this._liveApiVersion}get liveApiClient(){return this._liveApiClient||(this._liveApiClient=new rt({apiKey:this.apiKey,httpOptions:{headers:this.trackingHeaders,apiVersion:this.liveApiVersion}})),this._liveApiClient}async connect(e){var o,r,i,s;(o=e.liveConnectConfig)!=null&&o.httpOptions&&(e.liveConnectConfig.httpOptions.headers||(e.liveConnectConfig.httpOptions.headers={}),Object.assign(e.liveConnectConfig.httpOptions.headers,this.trackingHeaders),e.liveConnectConfig.httpOptions.apiVersion=this.liveApiVersion),(r=e.config)!=null&&r.systemInstruction&&(e.liveConnectConfig.systemInstruction={role:"system",parts:[pn(e.config.systemInstruction)]}),e.liveConnectConfig.tools=(i=e.config)==null?void 0:i.tools;let t=await this.liveApiClient.live.connect({model:(s=e.model)!=null?s:this.model,config:e.liveConnectConfig,callbacks:{onmessage:()=>{}}});return new Te(t)}preprocessRequest(e){if(this.apiBackend==="GEMINI_API"&&(e.config&&(e.config.labels=void 0),e.contents)){for(let t of e.contents)if(t.parts)for(let o of t.parts)mn(o.inlineData),mn(o.fileData)}}};se.supportedModels=[/gemini-.*/,/projects\/.+\/locations\/.+\/endpoints\/.+/,/projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+/];function mn(n){n&&n.displayName&&(n.displayName=void 0)}var it=class{constructor(e){this.maxSize=e,this.cache=new Map}get(e){let t=this.cache.get(e);return t&&(this.cache.delete(e),this.cache.set(e,t)),t}set(e,t){if(this.cache.size>=this.maxSize&&!this.cache.has(e)){let o=this.cache.keys().next().value;o!==void 0&&this.cache.delete(o)}this.cache.set(e,t)}},O=class O{static newLlm(e){return new(O.resolve(e))({model:e})}static _register(e,t){O.llmRegistryDict.has(e)&&y.info("Updating LLM class for ".concat(e," from ").concat(O.llmRegistryDict.get(e)," to ").concat(t)),O.llmRegistryDict.set(e,t)}static register(e){for(let t of e.supportedModels)O._register(t,e)}static resolve(e){let t=O.resolveCache.get(e);if(t)return t;for(let[o,r]of O.llmRegistryDict.entries())if(new RegExp("^".concat(o instanceof RegExp?o.source:o,"$"),o instanceof RegExp?o.flags:void 0).test(e))return O.resolveCache.set(e,r),r;throw new Error("Model ".concat(e," not found."))}};O.llmRegistryDict=new Map,O.resolveCache=new it(32);var ae=O;ae.register(se);var st=Symbol.for("google.adk.baseTool");function Io(n){return typeof n=="object"&&n!==null&&st in n&&n[st]===!0}var gn;gn=st;var D=class{constructor(e){this[gn]=!0;var t;this.name=e.name,this.description=e.description,this.isLongRunning=(t=e.isLongRunning)!=null?t:!1}_getDeclaration(){}async processLlmRequest({toolContext:e,llmRequest:t}){let o=this._getDeclaration();if(!o)return;t.toolsDict[this.name]=this;let r=wo(t);r?(r.functionDeclarations||(r.functionDeclarations=[]),r.functionDeclarations.push(o)):(t.config=t.config||{},t.config.tools=t.config.tools||[],t.config.tools.push({functionDeclarations:[o]}))}get apiVariant(){return dn()}};function wo(n){var e;return(((e=n.config)==null?void 0:e.tools)||[]).find(t=>"functionDeclarations"in t)}import{Type as ko}from"@google/genai";import{ZodObject as Lo}from"zod";import{Type as P}from"@google/genai";import{z as I}from"zod";function hn(n){var e;return n!==null&&typeof n=="object"&&((e=n._def)==null?void 0:e.typeName)==="ZodObject"}function U(n){let e=n._def;if(!e)return{};let t=e.description,o={};t&&(o.description=t);let r=i=>(i.description===void 0&&delete i.description,i);switch(e.typeName){case I.ZodFirstPartyTypeKind.ZodString:o.type=P.STRING;for(let a of e.checks||[])a.kind==="min"?o.minLength=a.value.toString():a.kind==="max"?o.maxLength=a.value.toString():a.kind==="email"?o.format="email":a.kind==="uuid"?o.format="uuid":a.kind==="url"?o.format="uri":a.kind==="regex"&&(o.pattern=a.regex.source);return r(o);case I.ZodFirstPartyTypeKind.ZodNumber:o.type=P.NUMBER;for(let a of e.checks||[])a.kind==="min"?o.minimum=a.value:a.kind==="max"?o.maximum=a.value:a.kind==="int"&&(o.type=P.INTEGER);return r(o);case I.ZodFirstPartyTypeKind.ZodBoolean:return o.type=P.BOOLEAN,r(o);case I.ZodFirstPartyTypeKind.ZodArray:return o.type=P.ARRAY,o.items=U(e.type),e.minLength&&(o.minItems=e.minLength.value.toString()),e.maxLength&&(o.maxItems=e.maxLength.value.toString()),r(o);case I.ZodFirstPartyTypeKind.ZodObject:return Se(n);case I.ZodFirstPartyTypeKind.ZodLiteral:let i=typeof e.value;if(o.enum=[e.value.toString()],i==="string")o.type=P.STRING;else if(i==="number")o.type=P.NUMBER;else if(i==="boolean")o.type=P.BOOLEAN;else if(e.value===null)o.type=P.NULL;else throw new Error("Unsupported ZodLiteral value type: ".concat(i));return r(o);case I.ZodFirstPartyTypeKind.ZodEnum:return o.type=P.STRING,o.enum=e.values,r(o);case I.ZodFirstPartyTypeKind.ZodNativeEnum:return o.type=P.STRING,o.enum=Object.values(e.values),r(o);case I.ZodFirstPartyTypeKind.ZodUnion:return o.anyOf=e.options.map(U),r(o);case I.ZodFirstPartyTypeKind.ZodOptional:return U(e.innerType);case I.ZodFirstPartyTypeKind.ZodNullable:let s=U(e.innerType);return r(s?x({anyOf:[s,{type:P.NULL}]},t&&{description:t}):x({type:P.NULL},t&&{description:t}));case I.ZodFirstPartyTypeKind.ZodDefault:let c=U(e.innerType);return c&&(c.default=e.defaultValue()),c;case I.ZodFirstPartyTypeKind.ZodBranded:return U(e.type);case I.ZodFirstPartyTypeKind.ZodReadonly:return U(e.innerType);case I.ZodFirstPartyTypeKind.ZodNull:return o.type=P.NULL,r(o);case I.ZodFirstPartyTypeKind.ZodAny:case I.ZodFirstPartyTypeKind.ZodUnknown:return r(x({},t&&{description:t}));default:throw new Error("Unsupported Zod type: ".concat(e.typeName))}}function Se(n){if(n._def.typeName!==I.ZodFirstPartyTypeKind.ZodObject)throw new Error("Expected a ZodObject");let e=n.shape,t={},o=[];for(let s in e){let c=e[s],a=U(c);a&&(t[s]=a);let l=c,u=!1;for(;l._def.typeName===I.ZodFirstPartyTypeKind.ZodOptional||l._def.typeName===I.ZodFirstPartyTypeKind.ZodDefault;)u=!0,l=l._def.innerType;u||o.push(s)}let r=n._def.catchall,i=!1;return r&&r._def.typeName!==I.ZodFirstPartyTypeKind.ZodNever?i=U(r)||!0:i=n._def.unknownKeys==="passthrough",x({type:P.OBJECT,properties:t,required:o.length>0?o:[]},n._def.description?{description:n._def.description}:{})}function Po(n){return n===void 0?{type:ko.OBJECT,properties:{}}:hn(n)?Se(n):n}var at=Symbol.for("google.adk.functionTool");function _o(n){return typeof n=="object"&&n!==null&&at in n&&n[at]===!0}var Cn,vn,j=class extends(vn=D,Cn=at,vn){constructor(t){var r;let o=(r=t.name)!=null?r:t.execute.name;if(!o)throw new Error("Tool name cannot be empty. Either name the `execute` function or provide a `name`.");super({name:o,description:t.description,isLongRunning:t.isLongRunning});this[Cn]=!0;this.execute=t.execute,this.parameters=t.parameters}_getDeclaration(){return{name:this.name,description:this.description,parameters:Po(this.parameters)}}async runAsync(t){try{let o=t.args;return this.parameters instanceof Lo&&(o=this.parameters.parse(t.args)),await this.execute(o,t.toolContext)}catch(o){let r=o instanceof Error?o.message:String(o);throw new Error("Error in tool '".concat(this.name,"': ").concat(r))}}};import{cloneDeep as Bo}from"lodash-es";function ct(n,e,t){var s,c,a;let o=[];for(let l of n)!((s=l.content)!=null&&s.role)||((a=(c=l.content.parts)==null?void 0:c[0])==null?void 0:a.text)===""||t&&l.branch&&!t.startsWith(l.branch)||Mo(l)||Oo(l)||o.push(xn(e,l)?No(l):l);let r=Fo(o);r=Do(r);let i=[];for(let l of r){let u=Bo(l.content);Wt(u),i.push(u)}return i}function An(n,e,t){for(let o=n.length-1;o>=0;o--){let r=n[o];if(r.author==="user"||xn(e,r))return ct(n.slice(o),e,t)}return[]}function Mo(n){var e,t,o;if(!((e=n.content)!=null&&e.parts))return!1;for(let r of n.content.parts)if(((t=r.functionCall)==null?void 0:t.name)===Ae||((o=r.functionResponse)==null?void 0:o.name)===Ae)return!0;return!1}function Oo(n){var e,t,o;if(!((e=n.content)!=null&&e.parts))return!1;for(let r of n.content.parts)if(((t=r.functionCall)==null?void 0:t.name)===re||((o=r.functionResponse)==null?void 0:o.name)===re)return!0;return!1}function xn(n,e){return!!n&&e.author!==n&&e.author!=="user"}function No(n){var t,o,r,i,s,c;if(!((o=(t=n.content)==null?void 0:t.parts)!=null&&o.length))return n;let e={role:"user",parts:[{text:"For context:"}]};for(let a of n.content.parts)if(a.text&&!a.thought)(r=e.parts)==null||r.push({text:"[".concat(n.author,"] said: ").concat(a.text)});else if(a.functionCall){let l=yn(a.functionCall.args);(i=e.parts)==null||i.push({text:"[".concat(n.author,"] called tool `").concat(a.functionCall.name,"` with parameters: ").concat(l)})}else if(a.functionResponse){let l=yn(a.functionResponse.response);(s=e.parts)==null||s.push({text:"[".concat(n.author,"] tool `").concat(a.functionResponse.name,"` returned result: ").concat(l)})}else(c=e.parts)==null||c.push(a);return R({invocationId:n.invocationId,author:"user",content:e,branch:n.branch,timestamp:n.timestamp})}function En(n){var r;if(n.length===0)throw new Error("Cannot merge an empty list of events.");let e=R(n[0]),t=((r=e.content)==null?void 0:r.parts)||[];if(t.length===0)throw new Error("There should be at least one function_response part.");let o={};for(let i=0;i<t.length;i++){let s=t[i];s.functionResponse&&s.functionResponse.id&&(o[s.functionResponse.id]=i)}for(let i of n.slice(1)){if(!i.content||!i.content.parts)throw new Error("There should be at least one function_response part.");for(let s of i.content.parts)if(s.functionResponse&&s.functionResponse.id){let c=s.functionResponse.id;c in o?t[o[c]]=s:(t.push(s),o[c]=t.length-1)}else t.push(s)}return e}function Fo(n){if(n.length===0)return n;let e=n[n.length-1],t=B(e);if(!(t!=null&&t.length))return n;let o=new Set(t.filter(a=>!!a.id).map(a=>a.id)),r=n.at(-2);if(r){let a=k(r);if(a){for(let l of a)if(l.id&&o.has(l.id))return n}}let i=-1;for(let a=n.length-2;a>=0;a--){let l=n[a],u=k(l);if(u!=null&&u.length){for(let d of u)if(d.id&&o.has(d.id)){i=a;let m=new Set(u.map(A=>A.id).filter(A=>!!A));if(!Array.from(o).every(A=>m.has(A)))throw new Error("Last response event should only contain the responses for the function calls in the same function call event. Function"+" call ids found : ".concat(Array.from(m).join(", "),", function response")+" ids provided: ".concat(Array.from(o).join(", ")));o=m;break}}}if(i===-1)throw new Error("No function call event found for function responses ids: ".concat(Array.from(o).join(", ")));let s=[];for(let a=i+1;a<n.length-1;a++){let l=n[a],u=B(l);u&&u.some(d=>d.id&&o.has(d.id))&&s.push(l)}s.push(n[n.length-1]);let c=n.slice(0,i+1);return c.push(En(s)),c}function Do(n){let e=new Map;for(let o=0;o<n.length;o++){let r=n[o],i=B(r);if(i!=null&&i.length)for(let s of i)s.id&&e.set(s.id,o)}let t=[];for(let o of n){if(B(o).length>0)continue;let r=k(o);if(r!=null&&r.length){let i=new Set;for(let s of r){let c=s.id;c&&e.has(c)&&i.add(e.get(c))}if(t.push(o),i.size===0)continue;if(i.size===1){let[s]=[...i];t.push(n[s])}else{let c=Array.from(i).sort((a,l)=>a-l).map(a=>n[a]);t.push(En(c))}}else t.push(o)}return t}function yn(n){if(typeof n=="string")return n;try{return JSON.stringify(n)}catch(e){return String(n)}}async function lt(n,e){let t=e.invocationContext;async function o(a){let l=a[0].replace(/^\{+/,"").replace(/\}+$/,"").trim(),u=l.endsWith("?");if(u&&(l=l.slice(0,-1)),l.startsWith("artifact.")){let d=l.substring(9);if(t.artifactService===void 0)throw new Error("Artifact service is not initialized.");let m=await t.artifactService.loadArtifact({appName:t.session.appName,userId:t.session.userId,sessionId:t.session.id,filename:d});if(!m)throw new Error("Artifact ".concat(d," not found."));return String(m)}if(!qo(l))return a[0];if(l in t.session.state)return String(t.session.state[l]);if(u)return"";throw new Error("Context variable not found: `".concat(l,"`."))}let r=/\{+[^{}]*}+/g,i=[],s=0,c=n.matchAll(r);for(let a of c){i.push(n.slice(s,a.index));let l=await o(a);i.push(l),s=a.index+a[0].length}return i.push(n.slice(s)),i.join("")}var Go=/^[a-zA-Z_][a-zA-Z0-9_]*$/;function bn(n){return n===""||n===void 0?!1:Go.test(n)}var $o=[T.APP_PREFIX,T.USER_PREFIX,T.TEMP_PREFIX];function qo(n){let e=n.split(":");return e.length===0||e.length>2?!1:e.length===1?bn(n):$o.includes(e[0]+":")?bn(e[1]):!1}var ut=(o=>(o.NONE="none",o.SSE="sse",o.BIDI="bidi",o))(ut||{});function Tn(n={}){return x({saveInputBlobsAsArtifacts:!1,supportCfc:!1,enableAffectiveDialog:!1,streamingMode:"none",maxLlmCalls:Uo(n.maxLlmCalls||500)},n)}function Uo(n){if(n>Number.MAX_SAFE_INTEGER)throw new Error("maxLlmCalls should be less than ".concat(Number.MAX_SAFE_INTEGER,"."));return n<=0&&y.warn("maxLlmCalls is less than or equal to 0. This will result in no enforcement on total number of llm calls that will be made for a run. This may not be ideal, as this could result in a never ending communication between the model and the agent in certain cases."),n}var In="adk_agent_name";async function wn(n,e){return n instanceof D?[n]:await n.getTools(e)}var ft=class extends ${runAsync(e,t){return C(this,null,function*(){var r;let o=e.agent;w(o)&&(t.model=o.canonicalModel.model,t.config=x({},(r=o.generateContentConfig)!=null?r:{}),o.outputSchema&&fn(t,o.outputSchema),e.runConfig&&(t.liveConnectConfig.responseModalities=e.runConfig.responseModalities,t.liveConnectConfig.speechConfig=e.runConfig.speechConfig,t.liveConnectConfig.outputAudioTranscription=e.runConfig.outputAudioTranscription,t.liveConnectConfig.inputAudioTranscription=e.runConfig.inputAudioTranscription,t.liveConnectConfig.realtimeInputConfig=e.runConfig.realtimeInputConfig,t.liveConnectConfig.enableAffectiveDialog=e.runConfig.enableAffectiveDialog,t.liveConnectConfig.proactivity=e.runConfig.proactivity))})}},jo=new ft,dt=class extends ${runAsync(e,t){return C(this,null,function*(){let o=e.agent,r=['You are an agent. Your internal name is "'.concat(o.name,'".')];o.description&&r.push('The description about you is "'.concat(o.description,'"')),me(t,r)})}},Ko=new dt,pt=class extends ${runAsync(e,t){return C(this,null,function*(){let o=e.agent;if(!(o instanceof Q)||!(o.rootAgent instanceof Q))return;let r=o.rootAgent;if(w(r)&&r.globalInstruction){let{instruction:i,requireStateInjection:s}=yield new f(r.canonicalGlobalInstruction(new _(e))),c=i;s&&(c=yield new f(lt(i,new _(e)))),me(t,[c])}if(o.instruction){let{instruction:i,requireStateInjection:s}=yield new f(o.canonicalInstruction(new _(e))),c=i;s&&(c=yield new f(lt(i,new _(e)))),me(t,[c])}})}},Vo=new pt,mt=class{runAsync(e,t){return C(this,null,function*(){let o=e.agent;!o||!w(o)||(o.includeContents==="default"?t.contents=ct(e.session.events,o.name,e.branch):t.contents=An(e.session.events,o.name,e.branch))})}},Zo=new mt,gt=class extends ${constructor(){super(...arguments);this.toolName="transfer_to_agent";this.tool=new j({name:this.toolName,description:"Transfer the question to another agent. This tool hands off control to another agent when it is more suitable to answer the user question according to the agent description.",parameters:Rn.object({agentName:Rn.string().describe("the agent name to transfer to.")}),execute:function(t,o){if(!o)throw new Error("toolContext is required.");return o.actions.transferToAgent=t.agentName,"Transfer queued"}})}runAsync(t,o){return C(this,null,function*(){if(!(t.agent instanceof Q))return;let r=this.getTransferTargets(t.agent);if(!r.length)return;me(o,[this.buildTargetAgentsInstructions(t.agent,r)]);let i=new K({invocationContext:t});yield new f(this.tool.processLlmRequest({toolContext:i,llmRequest:o}))})}buildTargetAgentsInfo(t){return"\nAgent name: ".concat(t.name,"\nAgent description: ").concat(t.description,"\n")}buildTargetAgentsInstructions(t,o){let r="\nYou have a list of other agents to transfer to:\n\n".concat(o.map(this.buildTargetAgentsInfo).join("\n"),"\n\nIf you are the best to answer the question according to your description, you\ncan answer it.\n\nIf another agent is better for answering the question according to its\ndescription, call `").concat(this.toolName,"` function to transfer the\nquestion to that agent. When transferring, do not generate any text other than\nthe function call.\n");return t.parentAgent&&!t.disallowTransferToParent&&(r+="\nYour parent agent is ".concat(t.parentAgent.name,". If neither the other agents nor\nyou are best for answering the question according to the descriptions, transfer\nto your parent agent.\n")),r}getTransferTargets(t){let o=[];return o.push(...t.subAgents),!t.parentAgent||!w(t.parentAgent)||(t.disallowTransferToParent||o.push(t.parentAgent),t.disallowTransferToPeers||o.push(...t.parentAgent.subAgents.filter(r=>r.name!==t.name))),o}},zo=new gt,ht=class extends ${runAsync(e,t){return C(this,null,function*(){let o=e.agent;if(!w(o))return;let r=e.session.events;if(!r||r.length===0)return;let i={},s=-1;for(let c=r.length-1;c>=0;c--){let a=r[c];if(a.author!=="user")continue;let l=B(a);if(!l)continue;let u=!1;for(let d of l){if(d.name!==re)continue;u=!0;let m=null;d.response&&Object.keys(d.response).length===1&&"response"in d.response?m=JSON.parse(d.response.response):d.response&&(m=new V({hint:d.response.hint,payload:d.response.payload,confirmed:d.response.confirmed})),d.id&&m&&(i[d.id]=m)}if(u){s=c;break}}if(Object.keys(i).length!==0)for(let c=s-1;c>=0;c--){let a=r[c],l=k(a);if(!l)continue;let u={},d={};for(let v of l){if(!v.id||!(v.id in i))continue;let h=v.args;if(!h||!("originalFunctionCall"in h))continue;let p=h.originalFunctionCall;p.id&&(u[p.id]=i[v.id],d[p.id]=p)}if(Object.keys(u).length===0)continue;for(let v=r.length-1;v>s;v--){let h=r[v],p=B(h);if(p){for(let E of p)E.id&&E.id in u&&(delete u[E.id],delete d[E.id]);if(Object.keys(u).length===0)break}}if(Object.keys(u).length===0)continue;let m=yield new f(o.canonicalTools(new _(e))),g=Object.fromEntries(m.map(v=>[v.name,v])),A=yield new f(xe({invocationContext:e,functionCalls:Object.values(d),toolsDict:g,beforeToolCallbacks:o.canonicalBeforeToolCallbacks,afterToolCallbacks:o.canonicalAfterToolCallbacks,filters:new Set(Object.keys(u)),toolConfirmationDict:u}));A&&(yield A);return}})}},Yo=new ht,Ct=class extends ${runAsync(e,t){return C(this,null,function*(){if(e.agent instanceof Q&&e.agent.codeExecutor){try{for(var o=b(Wo(e,t)),r,i,s;r=!(i=yield new f(o.next())).done;r=!1){let c=i.value;yield c}}catch(i){s=[i]}finally{try{r&&(i=o.return)&&(yield new f(i.call(o)))}finally{if(s)throw s[0]}}if(Ee(e.agent.codeExecutor))for(let c of t.contents){let a=e.agent.codeExecutor.codeBlockDelimiters.length?e.agent.codeExecutor.codeBlockDelimiters[0]:["",""],l=cn(c,a,e.agent.codeExecutor.executionResultDelimiters)}}})}},Re={"text/csv":{extension:".csv",loaderCodeTemplate:"pd.read_csv('{filename}')"}},Qo="\nimport pandas as pd\n\ndef explore_df(df: pd.DataFrame) -> None:\n  \"\"\"Prints some information about a pandas DataFrame.\"\"\"\n\n  with pd.option_context(\n      'display.max_columns', None, 'display.expand_frame_repr', False\n  ):\n    # Print the column names to never encounter KeyError when selecting one.\n    df_dtypes = df.dtypes\n\n    # Obtain information about data types and missing values.\n    df_nulls = (len(df) - df.isnull().sum()).apply(\n        lambda x: f'{x} / {df.shape[0]} non-null'\n    )\n\n    # Explore unique total values in columns using `.unique()`.\n    df_unique_count = df.apply(lambda x: len(x.unique()))\n\n    # Explore unique values in columns using `.unique()`.\n    df_unique = df.apply(lambda x: crop(str(list(x.unique()))))\n\n    df_info = pd.concat(\n        (\n            df_dtypes.rename('Dtype'),\n            df_nulls.rename('Non-Null Count'),\n            df_unique_count.rename('Unique Values Count'),\n            df_unique.rename('Unique Values'),\n        ),\n        axis=1,\n    )\n    df_info.index.name = 'Columns'\n    print(f\"\"\"Total rows: {df.shape[0]}\nTotal columns: {df.shape[1]}\n\n{df_info}\"\"\")\n",vt=class{runAsync(e,t){return C(this,null,function*(){if(!t.partial)try{for(var o=b(Xo(e,t)),r,i,s;r=!(i=yield new f(o.next())).done;r=!1){let c=i.value;yield c}}catch(i){s=[i]}finally{try{r&&(i=o.return)&&(yield new f(i.call(o)))}finally{if(s)throw s[0]}}})}},ca=new vt;function Wo(n,e){return C(this,null,function*(){let t=n.agent;if(!w(t))return;let o=t.codeExecutor;if(!o||!Ee(o))return;if(de(o)){o.processLlmRequest(e);return}if(!o.optimizeDataFile)return;let r=new pe(new T(n.session.state));if(r.getErrorCount(n.invocationId)>=o.errorRetryAttempts)return;let i=Ho(r,e),s=new Set(r.getProcessedFileNames()),c=i.filter(a=>!s.has(a.name));for(let a of c){let l=Jo(a);if(!l)return;let u={role:"model",parts:[{text:"Processing input file: `".concat(a.name,"`")},We(l)]};e.contents.push(Sn(u)),yield R({invocationId:n.invocationId,author:t.name,branch:n.branch,content:u});let d=Pn(n,r),m=yield new f(o.executeCode({invocationContext:n,codeExecutionInput:{code:l,inputFiles:[a],executionId:d}}));r.updateCodeExecutionResult({invocationId:n.invocationId,code:l,resultStdout:m.stdout,resultStderr:m.stderr}),r.addProcessedFileNames([a.name]);let g=yield new f(_n(n,r,m));yield g,e.contents.push(Sn(g.content))}})}function Xo(n,e){return C(this,null,function*(){let t=n.agent;if(!w(t))return;let o=t.codeExecutor;if(!o||!Ee(o)||!e||!e.content||de(o))return;let r=new pe(new T(n.session.state));if(r.getErrorCount(n.invocationId)>=o.errorRetryAttempts)return;let i=e.content,s=sn(i,o.codeBlockDelimiters);if(!s)return;yield R({invocationId:n.invocationId,author:t.name,branch:n.branch,content:i});let c=Pn(n,r),a=yield new f(o.executeCode({invocationContext:n,codeExecutionInput:{code:s,inputFiles:r.getInputFiles(),executionId:c}}));r.updateCodeExecutionResult({invocationId:n.invocationId,code:s,resultStdout:a.stdout,resultStderr:a.stderr}),yield yield new f(_n(n,r,a)),e.content=null})}function Ho(n,e){var r;let t=n.getInputFiles(),o=new Set(t.map(i=>i.name));for(let i=0;i<e.contents.length;i++){let s=e.contents[i];if(!(s.role!=="user"||!s.parts))for(let c=0;c<s.parts.length;c++){let a=s.parts[c],l=(r=a.inlineData)==null?void 0:r.mimeType;if(!l||!a.inlineData||!Re[l])continue;let u="data_".concat(i+1,"_").concat(c+1).concat(Re[l].extension);a.text="\nAvailable file: `".concat(u,"`\n");let d={name:u,content:Ut(a.inlineData.data),mimeType:l};o.has(u)||(n.addInputFiles([d]),t.push(d))}}return t}function Pn(n,e){var r;let t=n.agent;if(!w(t)||!((r=t.codeExecutor)!=null&&r.stateful))return;let o=e.getExecutionId();return o||(o=n.session.id,e.setExecutionId(o)),o}async function _n(n,e,t){if(!n.artifactService)throw new Error("Artifact service is not initialized.");let o={role:"model",parts:[an(t)]},r=G({stateDelta:e.getStateDelta()});t.stderr?e.incrementErrorCount(n.invocationId):e.resetErrorCount(n.invocationId);for(let i of t.outputFiles){let s=await n.artifactService.saveArtifact({appName:n.appName||"",userId:n.userId||"",sessionId:n.session.id,filename:i.name,artifact:{inlineData:{data:i.content,mimeType:i.mimeType}}});r.artifactDelta[i.name]=s}return R({invocationId:n.invocationId,author:n.agent.name,branch:n.branch,content:o,actions:r})}function Jo(n){function e(r){let[i]=r.split("."),s=i.replace(/[^a-zA-Z0-9_]/g,"_");return/^\d/.test(s)&&(s="_"+s),s}if(!Re[n.mimeType])return;let t=e(n.name),o=Re[n.mimeType].loaderCodeTemplate.replace("{filename}",n.name);return"\n".concat(Qo,"\n\n# Load the dataframe.\n").concat(t," = ").concat(o,"\n\n# Use `explore_df` to guide my analysis.\nexplore_df(").concat(t,")\n")}var er=new Ct,yt=Symbol.for("google.adk.llmAgent");function w(n){return typeof n=="object"&&n!==null&&yt in n&&n[yt]===!0}var kn,Ln,Q=class n extends(Ln=F,kn=yt,Ln){constructor(t){var r,i,s,c,a,l,u,d,m;super(t);this[kn]=!0;if(this.model=t.model,this.instruction=(r=t.instruction)!=null?r:"",this.globalInstruction=(i=t.globalInstruction)!=null?i:"",this.tools=(s=t.tools)!=null?s:[],this.generateContentConfig=t.generateContentConfig,this.disallowTransferToParent=(c=t.disallowTransferToParent)!=null?c:!1,this.disallowTransferToPeers=(a=t.disallowTransferToPeers)!=null?a:!1,this.includeContents=(l=t.includeContents)!=null?l:"default",this.inputSchema=t.inputSchema,this.outputSchema=t.outputSchema,this.outputKey=t.outputKey,this.beforeModelCallback=t.beforeModelCallback,this.afterModelCallback=t.afterModelCallback,this.beforeToolCallback=t.beforeToolCallback,this.afterToolCallback=t.afterToolCallback,this.codeExecutor=t.codeExecutor,this.requestProcessors=(u=t.requestProcessors)!=null?u:[jo,Ko,Vo,Yo,Zo,er],this.responseProcessors=(d=t.responseProcessors)!=null?d:[],this.disallowTransferToParent&&this.disallowTransferToPeers&&!((m=this.subAgents)!=null&&m.length)||this.requestProcessors.push(zo),t.generateContentConfig){if(t.generateContentConfig.tools)throw new Error("All tools must be set via LlmAgent.tools.");if(t.generateContentConfig.systemInstruction)throw new Error("System instruction must be set via LlmAgent.instruction.");if(t.generateContentConfig.responseSchema)throw new Error("Response schema must be set via LlmAgent.output_schema.")}else this.generateContentConfig={};if(this.outputSchema){if((!this.disallowTransferToParent||!this.disallowTransferToPeers)&&(y.warn("Invalid config for agent ".concat(this.name,": outputSchema cannot co-exist with agent transfer configurations. Setting disallowTransferToParent=true, disallowTransferToPeers=true")),this.disallowTransferToParent=!0,this.disallowTransferToPeers=!0),this.subAgents&&this.subAgents.length>0)throw new Error("Invalid config for agent ".concat(this.name,": if outputSchema is set, subAgents must be empty to disable agent transfer."));if(this.tools&&this.tools.length>0)throw new Error("Invalid config for agent ".concat(this.name,": if outputSchema is set, tools must be empty"))}}get canonicalModel(){if(nt(this.model))return this.model;if(typeof this.model=="string"&&this.model)return ae.newLlm(this.model);let t=this.parentAgent;for(;t;){if(w(t))return t.canonicalModel;t=t.parentAgent}throw new Error("No model found for ".concat(this.name,"."))}async canonicalInstruction(t){return typeof this.instruction=="string"?{instruction:this.instruction,requireStateInjection:!0}:{instruction:await this.instruction(t),requireStateInjection:!1}}async canonicalGlobalInstruction(t){return typeof this.globalInstruction=="string"?{instruction:this.globalInstruction,requireStateInjection:!0}:{instruction:await this.globalInstruction(t),requireStateInjection:!1}}async canonicalTools(t){let o=[];for(let r of this.tools){let i=await wn(r,t);o.push(...i)}return o}static normalizeCallbackArray(t){return t?Array.isArray(t)?t:[t]:[]}get canonicalBeforeModelCallbacks(){return n.normalizeCallbackArray(this.beforeModelCallback)}get canonicalAfterModelCallbacks(){return n.normalizeCallbackArray(this.afterModelCallback)}get canonicalBeforeToolCallbacks(){return n.normalizeCallbackArray(this.beforeToolCallback)}get canonicalAfterToolCallbacks(){return n.normalizeCallbackArray(this.afterToolCallback)}maybeSaveOutputToState(t){var i,s;if(t.author!==this.name){y.debug("Skipping output save for agent ".concat(this.name,": event authored by ").concat(t.author));return}if(!this.outputKey){y.debug("Skipping output save for agent ".concat(this.name,": outputKey is not set"));return}if(!te(t)){y.debug("Skipping output save for agent ".concat(this.name,": event is not a final response"));return}if(!((s=(i=t.content)==null?void 0:i.parts)!=null&&s.length)){y.debug("Skipping output save for agent ".concat(this.name,": event content is empty"));return}let o=t.content.parts.map(c=>c.text?c.text:"").join(""),r=o;if(this.outputSchema){if(!o.trim())return;try{r=JSON.parse(o)}catch(c){y.error("Error parsing output for agent ".concat(this.name),c)}}t.actions.stateDelta[this.outputKey]=r}runAsyncImpl(t){return C(this,null,function*(){for(;;){let c;try{for(var o=b(this.runOneStepAsync(t)),r,i,s;r=!(i=yield new f(o.next())).done;r=!1){let a=i.value;c=a,this.maybeSaveOutputToState(a),yield a}}catch(i){s=[i]}finally{try{r&&(i=o.return)&&(yield new f(i.call(o)))}finally{if(s)throw s[0]}}if(!c||te(c))break;if(c.partial){y.warn("The last event is partial, which is not expected.");break}}})}runLiveImpl(t){return C(this,null,function*(){try{for(var o=b(this.runLiveFlow(t)),r,i,s;r=!(i=yield new f(o.next())).done;r=!1){let c=i.value;this.maybeSaveOutputToState(c),yield c}}catch(i){s=[i]}finally{try{r&&(i=o.return)&&(yield new f(i.call(o)))}finally{if(s)throw s[0]}}t.endInvocation})}runLiveFlow(t){return C(this,null,function*(){throw yield new f(Promise.resolve()),new Error("LlmAgent.runLiveFlow not implemented")})}runOneStepAsync(t){return C(this,null,function*(){let o={contents:[],toolsDict:{},liveConnectConfig:{}};for(let p of this.requestProcessors)try{for(var i=b(p.runAsync(t,o)),s,c,a;s=!(c=yield new f(i.next())).done;s=!1){let E=c.value;yield E}}catch(c){a=[c]}finally{try{s&&(c=i.return)&&(yield new f(c.call(i)))}finally{if(a)throw a[0]}}for(let p of this.tools){let E=new K({invocationContext:t}),N=yield new f(wn(p,new _(t)));for(let S of N)yield new f(S.processLlmRequest({toolContext:E,llmRequest:o}))}if(t.endInvocation)return;let r=R({invocationId:t.invocationId,author:this.name,branch:t.branch});try{for(var g=b(this.callLlmAsync(t,o,r)),A,v,h;A=!(v=yield new f(g.next())).done;A=!1){let p=v.value;try{for(var l=b(this.postprocess(t,o,p,r)),u,d,m;u=!(d=yield new f(l.next())).done;u=!1){let E=d.value;r.id=Fe(),r.timestamp=new Date().getTime(),yield E}}catch(d){m=[d]}finally{try{u&&(d=l.return)&&(yield new f(d.call(l)))}finally{if(m)throw m[0]}}}}catch(v){h=[v]}finally{try{A&&(v=g.return)&&(yield new f(v.call(g)))}finally{if(h)throw h[0]}}})}postprocess(t,o,r,i){return C(this,null,function*(){var v;for(let S of this.responseProcessors)try{for(var d=b(S.runAsync(t,r)),m,g,A;m=!(g=yield new f(d.next())).done;m=!1){let L=g.value;yield L}}catch(g){A=[g]}finally{try{m&&(g=d.return)&&(yield new f(g.call(d)))}finally{if(A)throw A[0]}}if(!r.content&&!r.errorCode&&!r.interrupted)return;let s=R(x(x({},i),r));if(s.content){let S=k(s);S!=null&&S.length&&(Qt(s),s.longRunningToolIds=Array.from(Xt(S,o.toolsDict)))}if(yield s,!((v=k(s))!=null&&v.length))return;let c=yield new f(Ht({invocationContext:t,functionCallEvent:s,toolsDict:o.toolsDict,beforeToolCallbacks:this.canonicalBeforeToolCallbacks,afterToolCallbacks:this.canonicalAfterToolCallbacks}));if(!c)return;let a=Ke(t,c);a&&(yield a);let l=Ve({invocationContext:t,functionCallEvent:s,functionResponseEvent:c});l&&(yield l),yield c;let u=c.actions.transferToAgent;if(u){let S=this.getAgentByName(t,u);try{for(var h=b(S.runAsync(t)),p,E,N;p=!(E=yield new f(h.next())).done;p=!1){let L=E.value;yield L}}catch(E){N=[E]}finally{try{p&&(E=h.return)&&(yield new f(E.call(h)))}finally{if(N)throw N[0]}}}})}getAgentByName(t,o){let i=t.agent.rootAgent.findAgent(o);if(!i)throw new Error("Agent ".concat(o," not found in the agent tree."));return i}callLlmAsync(t,o,r){return C(this,null,function*(){var c,a,l,u,d;let i=yield new f(this.handleBeforeModelCallback(t,o,r));if(i){yield i;return}(c=o.config)!=null||(o.config={}),(l=(a=o.config).labels)!=null||(a.labels={}),o.config.labels[In]||(o.config.labels[In]=this.name);let s=this.canonicalModel;if((u=t.runConfig)!=null&&u.supportCfc)throw new Error("CFC is not yet supported in callLlmAsync");{t.incrementLlmCallCount();let h=s.generateContentAsync(o,((d=t.runConfig)==null?void 0:d.streamingMode)==="sse");try{for(var m=b(this.runAndHandleError(h,t,o,r)),g,A,v;g=!(A=yield new f(m.next())).done;g=!1){let p=A.value;let E=yield new f(this.handleAfterModelCallback(t,p,r));yield E!=null?E:p}}catch(A){v=[A]}finally{try{g&&(A=m.return)&&(yield new f(A.call(m)))}finally{if(v)throw v[0]}}}})}async handleBeforeModelCallback(t,o,r){let i=new M({invocationContext:t,eventActions:r.actions}),s=await t.pluginManager.runBeforeModelCallback({callbackContext:i,llmRequest:o});if(s)return s;for(let c of this.canonicalBeforeModelCallbacks){let a=await c({context:i,request:o});if(a)return a}}async handleAfterModelCallback(t,o,r){let i=new M({invocationContext:t,eventActions:r.actions}),s=await t.pluginManager.runAfterModelCallback({callbackContext:i,llmResponse:o});if(s)return s;for(let c of this.canonicalAfterModelCallbacks){let a=await c({context:i,response:o});if(a)return a}}runAndHandleError(t,o,r,i){return C(this,null,function*(){try{try{for(var s=b(t),c,a,l;c=!(a=yield new f(s.next())).done;c=!1){let u=a.value;yield u}}catch(a){l=[a]}finally{try{c&&(a=s.return)&&(yield new f(a.call(s)))}finally{if(l)throw l[0]}}}catch(u){let d=new M({invocationContext:o,eventActions:i.actions});if(u instanceof Error){let m=yield new f(o.pluginManager.runOnModelErrorCallback({callbackContext:d,llmRequest:r,error:u}));if(m)yield m;else{let g=JSON.parse(u.message);yield{errorCode:String(g.error.code),errorMessage:g.error.message}}}else throw y.error("Unknown error during response generation",u),u}})}};var At=Symbol.for("google.adk.loopAgent");function tr(n){return typeof n=="object"&&n!==null&&At in n&&n[At]===!0}var Bn,Mn,xt=class extends(Mn=F,Bn=At,Mn){constructor(t){var o;super(t);this[Bn]=!0;this.maxIterations=(o=t.maxIterations)!=null?o:Number.MAX_SAFE_INTEGER}runAsyncImpl(t){return C(this,null,function*(){let o=0;for(;o<this.maxIterations;){for(let a of this.subAgents){let l=!1;try{for(var r=b(a.runAsync(t)),i,s,c;i=!(s=yield new f(r.next())).done;i=!1){let u=s.value;yield u,u.actions.escalate&&(l=!0)}}catch(s){c=[s]}finally{try{i&&(s=r.return)&&(yield new f(s.call(r)))}finally{if(c)throw c[0]}}if(l)return}o++}})}runLiveImpl(t){return C(this,null,function*(){throw new Error("This is not supported yet for LoopAgent.")})}};var Et=Symbol.for("google.adk.parallelAgent");function nr(n){return typeof n=="object"&&n!==null&&Et in n&&n[Et]===!0}var On,Nn,bt=class extends(Nn=F,On=Et,Nn){constructor(){super(...arguments);this[On]=!0}runAsyncImpl(t){return C(this,null,function*(){let o=this.subAgents.map(a=>a.runAsync(or(this,a,t)));try{for(var r=b(rr(o)),i,s,c;i=!(s=yield new f(r.next())).done;i=!1){let a=s.value;yield a}}catch(s){c=[s]}finally{try{i&&(s=r.return)&&(yield new f(s.call(r)))}finally{if(c)throw c[0]}}})}runLiveImpl(t){return C(this,null,function*(){throw new Error("This is not supported yet for ParallelAgent.")})}};function or(n,e,t){let o=new q(t),r="".concat(n.name,".").concat(e.name);return o.branch=o.branch?"".concat(o.branch,".").concat(r):r,o}function rr(n){return C(this,null,function*(){let e=new Map;for(let[t,o]of n.entries()){let r=o.next().then(i=>({result:i,index:t}));e.set(t,r)}for(;e.size>0;){let{result:t,index:o}=yield new f(Promise.race(e.values()));if(t.done){e.delete(o);continue}yield t.value;let r=n[o].next().then(i=>({result:i,index:o}));e.set(o,r)}})}var Tt="task_completed",St=Symbol.for("google.adk.sequentialAgent");function ir(n){return typeof n=="object"&&n!==null&&St in n&&n[St]===!0}var Fn,Dn,Rt=class extends(Dn=F,Fn=St,Dn){constructor(){super(...arguments);this[Fn]=!0}runAsyncImpl(t){return C(this,null,function*(){for(let c of this.subAgents)try{for(var o=b(c.runAsync(t)),r,i,s;r=!(i=yield new f(o.next())).done;r=!1){let a=i.value;yield a}}catch(i){s=[i]}finally{try{r&&(i=o.return)&&(yield new f(i.call(o)))}finally{if(s)throw s[0]}}})}runLiveImpl(t){return C(this,null,function*(){for(let c of this.subAgents)w(c)&&((yield new f(c.canonicalTools(new _(t)))).some(u=>u.name===Tt)||(c.tools.push(new j({name:Tt,description:"Signals that the model has successfully completed the user's question or task.",execute:()=>"Task completion signaled."})),c.instruction+="If you finished the user's request according to its description, call the ".concat(Tt," function to exit so the next agents can take over. When calling this function, do not generate any text other than the function call.")));for(let c of this.subAgents)try{for(var o=b(c.runLive(t)),r,i,s;r=!(i=yield new f(o.next())).done;r=!1){let a=i.value;yield a}}catch(i){s=[i]}finally{try{r&&(i=o.return)&&(yield new f(i.call(o)))}finally{if(s)throw s[0]}}})}};var ge=class{constructor(){this.artifacts={}}saveArtifact({appName:e,userId:t,sessionId:o,filename:r,artifact:i}){let s=Ie(e,t,o,r);this.artifacts[s]||(this.artifacts[s]=[]);let c=this.artifacts[s].length;return this.artifacts[s].push(i),Promise.resolve(c)}loadArtifact({appName:e,userId:t,sessionId:o,filename:r,version:i}){let s=Ie(e,t,o,r),c=this.artifacts[s];return c?(i===void 0&&(i=c.length-1),Promise.resolve(c[i])):Promise.resolve(void 0)}listArtifactKeys({appName:e,userId:t,sessionId:o}){let r="".concat(e,"/").concat(t,"/").concat(o,"/"),i="".concat(e,"/").concat(t,"/user/"),s=[];for(let c in this.artifacts)if(c.startsWith(r)){let a=c.replace(r,"");s.push(a)}else if(c.startsWith(i)){let a=c.replace(i,"");s.push(a)}return Promise.resolve(s.sort())}deleteArtifact({appName:e,userId:t,sessionId:o,filename:r}){let i=Ie(e,t,o,r);return this.artifacts[i]&&delete this.artifacts[i],Promise.resolve()}listVersions({appName:e,userId:t,sessionId:o,filename:r}){let i=Ie(e,t,o,r),s=this.artifacts[i];if(!s)return Promise.resolve([]);let c=[];for(let a=0;a<s.length;a++)c.push(a);return Promise.resolve(c)}};function Ie(n,e,t,o){return sr(o)?"".concat(n,"/").concat(e,"/user/").concat(o):"".concat(n,"/").concat(e,"/").concat(t,"/").concat(o)}function sr(n){return n.startsWith("user:")}var Gn=(i=>(i.API_KEY="apiKey",i.HTTP="http",i.OAUTH2="oauth2",i.OPEN_ID_CONNECT="openIdConnect",i.SERVICE_ACCOUNT="serviceAccount",i))(Gn||{});var It=Symbol.for("google.adk.baseExampleProvider");function ar(n){return typeof n=="object"&&n!==null&&It in n&&n[It]===!0}var $n;$n=It;var wt=class{constructor(){this[$n]=!0}};var W=class{constructor(){this.memories=[];this.sessionEvents={}}async addSessionToMemory(e){let t=qn(e.appName,e.userId);this.sessionEvents[t]||(this.sessionEvents[t]={}),this.sessionEvents[t][e.id]=e.events.filter(o=>{var r,i,s;return((s=(i=(r=o.content)==null?void 0:r.parts)==null?void 0:i.length)!=null?s:0)>0})}async searchMemory(e){var i,s;let t=qn(e.appName,e.userId);if(!this.sessionEvents[t])return Promise.resolve({memories:[]});let o=e.query.toLowerCase().split(/\s+/),r={memories:[]};for(let c of Object.values(this.sessionEvents[t]))for(let a of c){if(!((s=(i=a.content)==null?void 0:i.parts)!=null&&s.length))continue;let l=a.content.parts.map(m=>m.text).filter(m=>!!m).join(" "),u=cr(l);if(!u.size)continue;o.some(m=>u.has(m))&&r.memories.push({content:a.content,author:a.author,timestamp:lr(a.timestamp)})}return r}};function qn(n,e){return"".concat(n,"/").concat(e)}function cr(n){return new Set([...n.matchAll(/[A-Za-z]+/)].map(e=>e[0].toLowerCase()))}function lr(n){return new Date(n).toISOString()}var X=class{constructor(e){this.name=e}async onUserMessageCallback(e){}async beforeRunCallback(e){}async onEventCallback(e){}async afterRunCallback(e){}async beforeAgentCallback(e){}async afterAgentCallback(e){}async beforeModelCallback(e){}async afterModelCallback(e){}async onModelErrorCallback(e){}async beforeToolCallback(e){}async afterToolCallback(e){}async onToolErrorCallback(e){}};var kt=class extends X{constructor(e="logging_plugin"){super(e)}async onUserMessageCallback({invocationContext:e,userMessage:t}){var o;this.log("\u{1F680} USER MESSAGE RECEIVED"),this.log("   Invocation ID: ".concat(e.invocationId)),this.log("   Session ID: ".concat(e.session.id)),this.log("   User ID: ".concat(e.userId)),this.log("   App Name: ".concat(e.appName)),this.log("   Root Agent: ".concat((o=e.agent.name)!=null?o:"Unknown")),this.log("   User Content: ".concat(this.formatContent(t))),e.branch&&this.log("   Branch: ".concat(e.branch))}async beforeRunCallback({invocationContext:e}){var t;this.log("\u{1F3C3} INVOCATION STARTING"),this.log("   Invocation ID: ".concat(e.invocationId)),this.log("   Starting Agent: ".concat((t=e.agent.name)!=null?t:"Unknown"))}async onEventCallback({invocationContext:e,event:t}){this.log("\u{1F4E2} EVENT YIELDED"),this.log("   Event ID: ".concat(t.id)),this.log("   Author: ".concat(t.author)),this.log("   Content: ".concat(this.formatContent(t.content))),this.log("   Final Response: ".concat(te(t)));let o=k(t);if(o.length>0){let i=o.map(s=>s.name);this.log("   Function Calls: ".concat(i))}let r=B(t);if(r.length>0){let i=r.map(s=>s.name);this.log("   Function Responses: ".concat(i))}t.longRunningToolIds&&t.longRunningToolIds.length>0&&this.log("   Long Running Tools: ".concat([...t.longRunningToolIds]))}async afterRunCallback({invocationContext:e}){var t;this.log("\u2705 INVOCATION COMPLETED"),this.log("   Invocation ID: ".concat(e.invocationId)),this.log("   Final Agent: ".concat((t=e.agent.name)!=null?t:"Unknown"))}async beforeAgentCallback({agent:e,callbackContext:t}){this.log("\u{1F916} AGENT STARTING"),this.log("   Agent Name: ".concat(t.agentName)),this.log("   Invocation ID: ".concat(t.invocationId)),t.invocationContext.branch&&this.log("   Branch: ".concat(t.invocationContext.branch))}async afterAgentCallback({agent:e,callbackContext:t}){this.log("\u{1F916} AGENT COMPLETED"),this.log("   Agent Name: ".concat(t.agentName)),this.log("   Invocation ID: ".concat(t.invocationId))}async beforeModelCallback({callbackContext:e,llmRequest:t}){var o;if(this.log("\u{1F9E0} LLM REQUEST"),this.log("   Model: ".concat((o=t.model)!=null?o:"default")),this.log("   Agent: ".concat(e.agentName)),t.config&&t.config.systemInstruction){let r=t.config.systemInstruction;r.length>200&&(r=r.substring(0,200)+"..."),this.log("   System Instruction: '".concat(r,"'"))}if(t.toolsDict){let r=Object.keys(t.toolsDict);this.log("   Available Tools: ".concat(r))}}async afterModelCallback({callbackContext:e,llmResponse:t}){this.log("\u{1F9E0} LLM RESPONSE"),this.log("   Agent: ".concat(e.agentName)),t.errorCode?(this.log("   \u274C ERROR - Code: ".concat(t.errorCode)),this.log("   Error Message: ".concat(t.errorMessage))):(this.log("   Content: ".concat(this.formatContent(t.content))),t.partial&&this.log("   Partial: ".concat(t.partial)),t.turnComplete!==void 0&&this.log("   Turn Complete: ".concat(t.turnComplete))),t.usageMetadata&&this.log("   Token Usage - Input: ".concat(t.usageMetadata.promptTokenCount,", Output: ").concat(t.usageMetadata.candidatesTokenCount))}async beforeToolCallback({tool:e,toolArgs:t,toolContext:o}){this.log("\u{1F527} TOOL STARTING"),this.log("   Tool Name: ".concat(e.name)),this.log("   Agent: ".concat(o.agentName)),this.log("   Function Call ID: ".concat(o.functionCallId)),this.log("   Arguments: ".concat(this.formatArgs(t)))}async afterToolCallback({tool:e,toolArgs:t,toolContext:o,result:r}){this.log("\u{1F527} TOOL COMPLETED"),this.log("   Tool Name: ".concat(e.name)),this.log("   Agent: ".concat(o.agentName)),this.log("   Function Call ID: ".concat(o.functionCallId)),this.log("   Result: ".concat(this.formatArgs(r)))}async onModelErrorCallback({callbackContext:e,llmRequest:t,error:o}){this.log("\u{1F9E0} LLM ERROR"),this.log("   Agent: ".concat(e.agentName)),this.log("   Error: ".concat(o))}async onToolErrorCallback({tool:e,toolArgs:t,toolContext:o,error:r}){this.log("\u{1F527} TOOL ERROR"),this.log("   Tool Name: ".concat(e.name)),this.log("   Agent: ".concat(o.agentName)),this.log("   Function Call ID: ".concat(o.functionCallId)),this.log("   Arguments: ".concat(this.formatArgs(t))),this.log("   Error: ".concat(r))}log(e){let t="\x1B[90m[".concat(this.name,"] ").concat(e,"\x1B[0m");y.info(t)}formatContent(e,t=200){if(!e||!e.parts)return"None";let o=[];for(let r of e.parts)if(r.text){let i=r.text.trim();i.length>t&&(i=i.substring(0,t)+"..."),o.push("text: '".concat(i,"'"))}else r.functionCall?o.push("function_call: ".concat(r.functionCall.name)):r.functionResponse?o.push("function_response: ".concat(r.functionResponse.name)):r.codeExecutionResult?o.push("code_execution_result"):o.push("other_part");return o.join(" | ")}formatArgs(e,t=300){if(!e)return"{}";let o=JSON.stringify(e);return o.length>t&&(o=o.substring(0,t)+"...}"),o}};var he=class{constructor(e){this.plugins=new Set;if(e)for(let t of e)this.registerPlugin(t)}registerPlugin(e){if(this.plugins.has(e))throw new Error("Plugin '".concat(e.name,"' already registered."));if(Array.from(this.plugins).some(t=>t.name===e.name))throw new Error("Plugin with name '".concat(e.name,"' already registered."));this.plugins.add(e),y.info("Plugin '".concat(e.name,"' registered."))}getPlugin(e){return Array.from(this.plugins).find(t=>t.name===e)}async runCallbacks(e,t,o){for(let r of e)try{let i=await t(r);if(i!==void 0)return y.debug("Plugin '".concat(r.name,"' returned a value for callback '").concat(o,"', exiting early.")),i}catch(i){let s="Error in plugin '".concat(r.name,"' during '").concat(o,"' callback: ").concat(i);throw y.error(s),new Error(s)}}async runOnUserMessageCallback({userMessage:e,invocationContext:t}){return await this.runCallbacks(this.plugins,o=>o.onUserMessageCallback({userMessage:e,invocationContext:t}),"onUserMessageCallback")}async runBeforeRunCallback({invocationContext:e}){return await this.runCallbacks(this.plugins,t=>t.beforeRunCallback({invocationContext:e}),"beforeRunCallback")}async runAfterRunCallback({invocationContext:e}){await this.runCallbacks(this.plugins,t=>t.afterRunCallback({invocationContext:e}),"afterRunCallback")}async runOnEventCallback({invocationContext:e,event:t}){return await this.runCallbacks(this.plugins,o=>o.onEventCallback({invocationContext:e,event:t}),"onEventCallback")}async runBeforeAgentCallback({agent:e,callbackContext:t}){return await this.runCallbacks(this.plugins,o=>o.beforeAgentCallback({agent:e,callbackContext:t}),"beforeAgentCallback")}async runAfterAgentCallback({agent:e,callbackContext:t}){return await this.runCallbacks(this.plugins,o=>o.afterAgentCallback({agent:e,callbackContext:t}),"afterAgentCallback")}async runBeforeToolCallback({tool:e,toolArgs:t,toolContext:o}){return await this.runCallbacks(this.plugins,r=>r.beforeToolCallback({tool:e,toolArgs:t,toolContext:o}),"beforeToolCallback")}async runAfterToolCallback({tool:e,toolArgs:t,toolContext:o,result:r}){return await this.runCallbacks(this.plugins,i=>i.afterToolCallback({tool:e,toolArgs:t,toolContext:o,result:r}),"afterToolCallback")}async runOnModelErrorCallback({callbackContext:e,llmRequest:t,error:o}){return await this.runCallbacks(this.plugins,r=>r.onModelErrorCallback({callbackContext:e,llmRequest:t,error:o}),"onModelErrorCallback")}async runBeforeModelCallback({callbackContext:e,llmRequest:t}){return await this.runCallbacks(this.plugins,o=>o.beforeModelCallback({callbackContext:e,llmRequest:t}),"beforeModelCallback")}async runAfterModelCallback({callbackContext:e,llmResponse:t}){return await this.runCallbacks(this.plugins,o=>o.afterModelCallback({callbackContext:e,llmResponse:t}),"afterModelCallback")}async runOnToolErrorCallback({tool:e,toolArgs:t,toolContext:o,error:r}){return await this.runCallbacks(this.plugins,i=>i.onToolErrorCallback({tool:e,toolArgs:t,toolContext:o,error:r}),"onToolErrorCallback")}};var jn="adk_request_confirmation",Lt="orcas_tool_call_security_check_states",Un="This tool call needs external confirmation before completion.",Kn=(o=>(o.DENY="DENY",o.CONFIRM="CONFIRM",o.ALLOW="ALLOW",o))(Kn||{}),we=class{async evaluate(e){return Promise.resolve({outcome:"ALLOW",reason:"For prototyping purpose, all tool calls are allowed."})}},Pt=class extends X{constructor(e){var t;super("security_plugin"),this.policyEngine=(t=e==null?void 0:e.policyEngine)!=null?t:new we}async beforeToolCallback({tool:e,toolArgs:t,toolContext:o}){let r=this.getToolCallCheckState(o);if(!r)return this.checkToolCallPolicy({tool:e,toolArgs:t,toolContext:o});if(r==="CONFIRM"){if(!o.toolConfirmation)return{partial:Un};if(this.setToolCallCheckState(o,o.toolConfirmation),!o.toolConfirmation.confirmed)return{error:"Tool call rejected from confirmation flow."};o.toolConfirmation=void 0}}getToolCallCheckState(e){var r;let{functionCallId:t}=e;return t?((r=e.state.get(Lt))!=null?r:{})[t]:void 0}setToolCallCheckState(e,t){var i;let{functionCallId:o}=e;if(!o)return;let r=(i=e.state.get(Lt))!=null?i:{};r[o]=t,e.state.set(Lt,r)}async checkToolCallPolicy({tool:e,toolArgs:t,toolContext:o}){let r=await this.policyEngine.evaluate({tool:e,toolArgs:t});switch(this.setToolCallCheckState(o,r.outcome),r.outcome){case"DENY":return{error:"This tool call is rejected by policy engine. Reason: ".concat(r.reason)};case"CONFIRM":return o.requestConfirmation({hint:"Policy engine requires confirmation calling tool: ".concat(e.name,". Reason: ").concat(r.reason)}),{partial:Un};case"ALLOW":return;default:return}}};function ur(n){if(!n.content||!n.content.parts)return[];let e=[];for(let t of n.content.parts)t&&t.functionCall&&t.functionCall.name===jn&&e.push(t.functionCall);return e}import{cloneDeep as Vn}from"lodash-es";var ke=class{async appendEvent({session:e,event:t}){return t.partial||(this.updateSessionState({session:e,event:t}),e.events.push(t)),t}updateSessionState({session:e,event:t}){if(!(!t.actions||!t.actions.stateDelta))for(let[o,r]of Object.entries(t.actions.stateDelta))o.startsWith(T.TEMP_PREFIX)||(e.state[o]=r)}};function Le(n){return{id:n.id,appName:n.appName,userId:n.userId||"",state:n.state||{},events:n.events||[],lastUpdateTime:n.lastUpdateTime||0}}var H=class extends ke{constructor(){super(...arguments);this.sessions={};this.userState={};this.appState={}}createSession({appName:t,userId:o,state:r,sessionId:i}){let s=Le({id:i||ne(),appName:t,userId:o,state:r,events:[],lastUpdateTime:Date.now()});return this.sessions[t]||(this.sessions[t]={}),this.sessions[t][o]||(this.sessions[t][o]={}),this.sessions[t][o][s.id]=s,Promise.resolve(this.mergeState(t,o,Vn(s)))}getSession({appName:t,userId:o,sessionId:r,config:i}){if(!this.sessions[t]||!this.sessions[t][o]||!this.sessions[t][o][r])return Promise.resolve(void 0);let s=this.sessions[t][o][r],c=Vn(s);if(i&&(i.numRecentEvents&&(c.events=c.events.slice(-i.numRecentEvents)),i.afterTimestamp)){let a=c.events.length-1;for(;a>=0&&!(c.events[a].timestamp<i.afterTimestamp);)a--;a>=0&&(c.events=c.events.slice(a+1))}return Promise.resolve(this.mergeState(t,o,c))}listSessions({appName:t,userId:o}){if(!this.sessions[t]||!this.sessions[t][o])return Promise.resolve({sessions:[]});let r=[];for(let i of Object.values(this.sessions[t][o]))r.push(Le({id:i.id,appName:i.appName,userId:i.userId,state:{},events:[],lastUpdateTime:i.lastUpdateTime}));return Promise.resolve({sessions:r})}async deleteSession({appName:t,userId:o,sessionId:r}){await this.getSession({appName:t,userId:o,sessionId:r})&&delete this.sessions[t][o][r]}async appendEvent({session:t,event:o}){await super.appendEvent({session:t,event:o}),t.lastUpdateTime=o.timestamp;let r=t.appName,i=t.userId,s=t.id,c=l=>{y.warn("Failed to append event to session ".concat(s,": ").concat(l))};if(!this.sessions[r])return c("appName ".concat(r," not in sessions")),o;if(!this.sessions[r][i])return c("userId ".concat(i," not in sessions[appName]")),o;if(!this.sessions[r][i][s])return c("sessionId ".concat(s," not in sessions[appName][userId]")),o;if(o.actions&&o.actions.stateDelta)for(let l of Object.keys(o.actions.stateDelta))l.startsWith(T.APP_PREFIX)&&(this.appState[r]=this.appState[r]||{},this.appState[r][l.replace(T.APP_PREFIX,"")]=o.actions.stateDelta[l]),l.startsWith(T.USER_PREFIX)&&(this.userState[r]=this.userState[r]||{},this.userState[r][i]=this.userState[r][i]||{},this.userState[r][i][l.replace(T.USER_PREFIX,"")]=o.actions.stateDelta[l]);let a=this.sessions[r][i][s];return await super.appendEvent({session:a,event:o}),a.lastUpdateTime=o.timestamp,o}mergeState(t,o,r){if(this.appState[t])for(let i of Object.keys(this.appState[t]))r.state[T.APP_PREFIX+i]=this.appState[t][i];if(!this.userState[t]||!this.userState[t][o])return r;for(let i of Object.keys(this.userState[t][o]))r.state[T.USER_PREFIX+i]=this.userState[t][o][i];return r}};import{createPartFromText as fr}from"@google/genai";import{trace as dr}from"@opentelemetry/api";var J=class{constructor(e){var t;this.appName=e.appName,this.agent=e.agent,this.pluginManager=new he((t=e.plugins)!=null?t:[]),this.artifactService=e.artifactService,this.sessionService=e.sessionService,this.memoryService=e.memoryService,this.credentialService=e.credentialService}runAsync(e){return C(this,null,function*(){var a;let{userId:t,sessionId:o,stateDelta:r}=e,i=Tn(e.runConfig),s=e.newMessage,c=dr.getTracer("gcp.vertex.agent").startSpan("invocation");try{let g=yield new f(this.sessionService.getSession({appName:this.appName,userId:t,sessionId:o}));if(!g)throw this.appName?new Error("Session not found: ".concat(o)):new Error("Session lookup failed: appName must be provided in runner constructor");if(i.supportCfc&&w(this.agent)){let p=this.agent.canonicalModel.model;if(!ue(p))throw new Error("CFC is not supported for model: ".concat(p," in agent: ").concat(this.agent.name));de(this.agent.codeExecutor)||(this.agent.codeExecutor=new fe)}let A=new q({artifactService:this.artifactService,sessionService:this.sessionService,memoryService:this.memoryService,credentialService:this.credentialService,invocationId:jt(),agent:this.agent,session:g,userContent:s,runConfig:i,pluginManager:this.pluginManager}),v=yield new f(this.pluginManager.runOnUserMessageCallback({userMessage:s,invocationContext:A}));if(v&&(s=v),s){if(!((a=s.parts)!=null&&a.length))throw new Error("No parts in the newMessage.");i.saveInputBlobsAsArtifacts&&(yield new f(this.saveArtifacts(A.invocationId,g.userId,g.id,s))),yield new f(this.sessionService.appendEvent({session:g,event:R({invocationId:A.invocationId,author:"user",actions:r?G({stateDelta:r}):void 0,content:s})}))}A.agent=this.determineAgentForResumption(g,this.agent);let h=yield new f(this.pluginManager.runBeforeRunCallback({invocationContext:A}));if(h){let p=R({invocationId:A.invocationId,author:"model",content:h});yield new f(this.sessionService.appendEvent({session:g,event:p})),yield p}else try{for(var l=b(A.agent.runAsync(A)),u,d,m;u=!(d=yield new f(l.next())).done;u=!1){let p=d.value;p.partial||(yield new f(this.sessionService.appendEvent({session:g,event:p})));let E=yield new f(this.pluginManager.runOnEventCallback({invocationContext:A,event:p}));E?yield E:yield p}}catch(d){m=[d]}finally{try{u&&(d=l.return)&&(yield new f(d.call(l)))}finally{if(m)throw m[0]}}yield new f(this.pluginManager.runAfterRunCallback({invocationContext:A}))}finally{c.end()}})}async saveArtifacts(e,t,o,r){var i;if(!(!this.artifactService||!((i=r.parts)!=null&&i.length)))for(let s=0;s<r.parts.length;s++){let c=r.parts[s];if(!c.inlineData)continue;let a="artifact_".concat(e,"_").concat(s);await this.artifactService.saveArtifact({appName:this.appName,userId:t,sessionId:o,filename:a,artifact:c}),r.parts[s]=fr("Uploaded file: ".concat(a,". It is saved into artifacts"))}}determineAgentForResumption(e,t){let o=pr(e.events);if(o&&o.author)return t.findAgent(o.author)||t;for(let r=e.events.length-1;r>=0;r--){y.info("event: ",JSON.stringify(e.events[r]));let i=e.events[r];if(i.author==="user"||!i.author)continue;if(i.author===t.name)return t;let s=t.findSubAgent(i.author);if(!s){y.warn("Event from an unknown agent: ".concat(i.author,", event id: ").concat(i.id));continue}if(this.isRoutableLlmAgent(s))return s}return t}isRoutableLlmAgent(e){let t=e;for(;t;){if(!w(t)||t.disallowTransferToParent)return!1;t=t.parentAgent}return!0}};function pr(n){var o,r,i,s;if(!n.length)return null;let t=(s=(i=(r=(o=n[n.length-1].content)==null?void 0:o.parts)==null?void 0:r.find(c=>c.functionResponse))==null?void 0:i.functionResponse)==null?void 0:s.id;if(!t)return null;for(let c=n.length-2;c>=0;c--){let a=n[c],l=k(a);if(l){for(let u of l)if(u.id===t)return a}}return null}var _t=class extends J{constructor({agent:e,appName:t="InMemoryRunner",plugins:o=[]}){super({appName:t,agent:e,plugins:o,artifactService:new ge,sessionService:new H,memoryService:new W})}};import{Type as _e}from"@google/genai";var Pe=class{constructor(e){this.toolContext=e;this.invocationContext=e.invocationContext}async saveArtifact(e){return this.toolContext.saveArtifact(e.filename,e.artifact)}async loadArtifact(e){return this.toolContext.loadArtifact(e.filename,e.version)}async listArtifactKeys(e){return this.toolContext.listArtifacts()}async deleteArtifact(e){if(!this.toolContext.invocationContext.artifactService)throw new Error("Artifact service is not initialized.");return this.toolContext.invocationContext.artifactService.deleteArtifact(e)}async listVersions(e){if(!this.toolContext.invocationContext.artifactService)throw new Error("Artifact service is not initialized.");return this.toolContext.invocationContext.artifactService.listVersions(e)}};var Bt=Symbol.for("google.adk.agentTool");function mr(n){return typeof n=="object"&&n!==null&&Bt in n&&n[Bt]===!0}var Zn,zn,Mt=class extends(zn=D,Zn=Bt,zn){constructor(t){super({name:t.agent.name,description:t.agent.description||""});this[Zn]=!0;this.agent=t.agent,this.skipSummarization=t.skipSummarization||!1}_getDeclaration(){let t;if(w(this.agent)&&this.agent.inputSchema?t={name:this.name,description:this.description,parameters:this.agent.inputSchema}:t={name:this.name,description:this.description,parameters:{type:_e.OBJECT,properties:{request:{type:_e.STRING}},required:["request"]}},this.apiVariant!=="GEMINI_API"){let o=w(this.agent)&&this.agent.outputSchema;t.response=o?{type:_e.OBJECT}:{type:_e.STRING}}return t}async runAsync({args:t,toolContext:o}){var v,h;this.skipSummarization&&(o.actions.skipSummarization=!0);let i={role:"user",parts:[{text:w(this.agent)&&this.agent.inputSchema?JSON.stringify(t):t.request}]},s=new J({appName:this.agent.name,agent:this.agent,artifactService:new Pe(o),sessionService:new H,memoryService:new W,credentialService:o.invocationContext.credentialService}),c=await s.sessionService.createSession({appName:this.agent.name,userId:"tmp_user",state:o.state.toRecord()}),a;try{for(var d=b(s.runAsync({userId:c.userId,sessionId:c.id,newMessage:i})),m,g,A;m=!(g=await d.next()).done;m=!1){let p=g.value;p.actions.stateDelta&&o.state.update(p.actions.stateDelta),a=p}}catch(g){A=[g]}finally{try{m&&(g=d.return)&&await g.call(d)}finally{if(A)throw A[0]}}if(!((h=(v=a==null?void 0:a.content)==null?void 0:v.parts)!=null&&h.length))return"";let l=w(this.agent)&&this.agent.outputSchema,u=a.content.parts.map(p=>p.text).filter(p=>p).join("\n");return l?JSON.parse(u):u}};var Ot=class{constructor(e){this.toolFilter=e}isToolSelected(e,t){return this.toolFilter?typeof this.toolFilter=="function"?this.toolFilter(e,t):Array.isArray(this.toolFilter)?this.toolFilter.includes(e.name):!1:!0}async processLlmRequest(e,t){}};var Be=class extends D{constructor(){super({name:"google_search",description:"Google Search Tool"})}runAsync(e){return Promise.resolve()}async processLlmRequest({toolContext:e,llmRequest:t}){if(t.model){if(t.config=t.config||{},t.config.tools=t.config.tools||[],tn(t.model)){if(t.config.tools.length>0)throw new Error("Google search tool can not be used with other tools in Gemini 1.x.");t.config.tools.push({googleSearchRetrieval:{}});return}if(en(t.model)){t.config.tools.push({googleSearch:{}});return}throw new Error("Google search tool is not supported for model ".concat(t.model))}}},gr=new Be;var Yn="\n\nNOTE: This is a long-running operation. Do not call this tool again if it has already returned some intermediate or pending status.",Nt=class extends j{constructor(e){super(ee(x({},e),{isLongRunning:!0}))}_getDeclaration(){let e=super._getDeclaration();return e.description?e.description+=Yn:e.description=Yn.trimStart(),e}};export{Ne as ActiveStreamingTool,Mt as AgentTool,Gn as AuthCredentialTypes,F as BaseAgent,le as BaseCodeExecutor,wt as BaseExampleProvider,ie as BaseLlm,$ as BaseLlmRequestProcessor,$e as BaseLlmResponseProcessor,X as BasePlugin,ke as BaseSessionService,D as BaseTool,Ot as BaseToolset,fe as BuiltInCodeExecutor,M as CallbackContext,j as FunctionTool,gr as GOOGLE_SEARCH,se as Gemini,be as GoogleLLMVariant,Be as GoogleSearchTool,ge as InMemoryArtifactService,W as InMemoryMemoryService,we as InMemoryPolicyEngine,_t as InMemoryRunner,H as InMemorySessionService,q as InvocationContext,ae as LLMRegistry,Ze as LiveRequestQueue,Q as LlmAgent,zt as LogLevel,kt as LoggingPlugin,Nt as LongRunningFunctionTool,xt as LoopAgent,bt as ParallelAgent,he as PluginManager,Kn as PolicyOutcome,jn as REQUEST_CONFIRMATION_FUNCTION_CALL_NAME,_ as ReadonlyContext,J as Runner,Pt as SecurityPlugin,Rt as SequentialAgent,T as State,ut as StreamingMode,V as ToolConfirmation,K as ToolContext,R as createEvent,G as createEventActions,Le as createSession,uo as functionsExportedForTestingOnly,ur as getAskUserConfirmationFunctionCalls,k as getFunctionCalls,B as getFunctionResponses,qt as hasTrailingCodeExecutionResult,mr as isAgentTool,to as isBaseAgent,ar as isBaseExampleProvider,nt as isBaseLlm,Io as isBaseTool,te as isFinalResponse,_o as isFunctionTool,ue as isGemini2OrAbove,w as isLlmAgent,tr as isLoopAgent,nr as isParallelAgent,ir as isSequentialAgent,io as setLogLevel,eo as stringifyContent,et as version,Se as zodObjectToSchema};
/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
//# sourceMappingURL=index.js.map
