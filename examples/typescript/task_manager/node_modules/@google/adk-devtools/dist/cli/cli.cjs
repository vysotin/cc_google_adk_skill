#! /usr/bin/env node
/**
  * @license
  * Copyright 2025 Google LLC
  * SPDX-License-Identifier: Apache-2.0
  */

"use strict";var He=Object.create;var Ie=Object.defineProperty;var We=Object.getOwnPropertyDescriptor;var Xe=Object.getOwnPropertyNames;var ze=Object.getPrototypeOf,Qe=Object.prototype.hasOwnProperty;var ye=(e,t)=>(t=Symbol[e])?t:Symbol.for("Symbol."+e),Se=e=>{throw TypeError(e)};var Ze=(e,t,s,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of Xe(t))!Qe.call(e,r)&&r!==s&&Ie(e,r,{get:()=>t[r],enumerable:!(n=We(t,r))||n.enumerable});return e};var f=(e,t,s)=>(s=e!=null?He(ze(e)):{},Ze(t||!e||!e.__esModule?Ie(s,"default",{value:e,enumerable:!0}):s,e));var k=(e,t,s)=>{if(t!=null){typeof t!="object"&&typeof t!="function"&&Se("Object expected");var n,r;s&&(n=t[ye("asyncDispose")]),n===void 0&&(n=t[ye("dispose")],s&&(r=n)),typeof n!="function"&&Se("Object not disposable"),r&&(n=function(){try{r.call(this)}catch(a){return Promise.reject(a)}}),e.push([s,n,t])}else s&&e.push([s]);return t},D=(e,t,s)=>{var n=typeof SuppressedError=="function"?SuppressedError:function(o,c,i,l){return l=Error(i),l.name="SuppressedError",l.error=o,l.suppressed=c,l},r=o=>t=s?new n(o,t,"An error was suppressed during disposal"):(s=!0,o),a=o=>{for(;o=e.pop();)try{var c=o[1]&&o[1].call(o[2]);if(o[0])return Promise.resolve(c).then(a,i=>(r(i),a()))}catch(i){r(i)}if(s)throw t};return a()};var Ye=f(require("os")),se=f(require("path")),Ve=f(require("dotenv")),O=require("commander"),A=require("@google/adk");var y=require("@google/adk"),xe=f(require("cors")),Y=f(require("express")),Te=f(require("path"));var Q=require("@google/adk"),_e=f(require("esbuild")),C=f(require("fs/promises")),j=f(require("path"));var S=f(require("fs/promises")),Ae=f(require("os")),W=f(require("path"));async function q(e){try{return await S.access(e),!0}catch{return!1}}async function ce(e){try{await S.mkdir(e)}catch(t){console.error(`Failed to create folder ${e}`,t)}}async function be(e){try{await S.rm(e,{recursive:!0})}catch(t){console.error(`Failed to remove folder ${e}`,t)}}async function Re(e){try{return await S.readdir(e)}catch(t){return console.error(`Failed to list files in folder ${e}`,t),[]}}async function X(e){try{return(await S.stat(e)).isFile()}catch{return!1}}async function K(e){try{return JSON.parse(await S.readFile(e,{encoding:"utf-8"}))}catch(t){throw console.error(`Failed to read or parse file ${e}:`,t),t}}async function N(e,t){try{await S.writeFile(e,typeof t=="string"?t:JSON.stringify(t,null,2),{encoding:"utf-8"})}catch(s){throw console.error(`Failed to write file ${e}:`,s),s}}function z(e){let t=[Ae.tmpdir()];return e&&t.push(e),t.push(Date.now().toString()),W.join(...t)}async function Ne(e,t,s){let n=e;for(let r=0;r<s;r++){let a=W.join(n,t);if(await q(a))return a;n=W.join(n,"../")}throw new Error(`No ${t} found in ${e} or its parent folders up to ${s} levels.`)}var et=[".ts",".mts"],tt=[".js",".cjs",".mjs",".ts",".mts"],L=class extends Error{};var Fe={bundle:"ts"},$=class{constructor(t,s=Fe){this.filePath=t;this.options=s;this.disposed=!1}async load(){if(this.agent)return this.agent;try{await C.stat(this.filePath)}catch(r){if(r.code==="ENOENT")throw new L(`Agent file ${this.filePath} does not exists`)}let t=this.filePath,s=j.extname(t);if(this.options.bundle==="any"||et.includes(s)){let r=j.parse(t),a=j.join(z("adk_agent_loader"),r.name+".cjs");await _e.default.build({entryPoints:[t],outfile:a,target:"node10.4",platform:"node",format:"cjs",packages:"bundle",bundle:!0,minify:!0,allowOverwrite:!0}),this.cleanupFilePath=a,t=a}let n=await Promise.resolve().then(()=>f(require(t)));if(n){if((0,Q.isBaseAgent)(n.rootAgent))return this.agent=n.rootAgent;if((0,Q.isBaseAgent)(n.default))return this.agent=n.default;let r=Object.values(n).filter(a=>(0,Q.isBaseAgent)(a));if(r.length>1&&console.warn(`Multiple agents found in ${t}. Using the ${r[0].name} as a root agent.`),r.length>0)return this.agent=r[0]}throw this.dispose(),new L(`Failed to load agent ${t}: No @google/adk BaseAgent class instance found. Please check that file is not empty and it has export of @google/adk BaseAgent class (e.g. LlmAgent) instance.`)}getFilePath(){if(!this.agent)throw new Error("Agent is not loaded yet");if(this.disposed)throw new Error("Agent is disposed and can not be used");return this.cleanupFilePath||this.filePath}async[Symbol.asyncDispose](){return this.dispose()}async dispose(){if(!this.disposed&&this.cleanupFilePath)return this.disposed=!0,C.unlink(this.cleanupFilePath)}},G=class{constructor(t=process.cwd(),s=Fe){this.agentsDirPath=t;this.options=s;this.agentsAlreadyPreloaded=!1;this.preloadedAgents={};let n=async({exit:r,cleanup:a})=>{a&&await this.disposeAll(),r&&process.exit()};process.on("exit",()=>n({cleanup:!0})),process.on("SIGINT",()=>n({exit:!0})),process.on("SIGUSR1",()=>n({exit:!0})),process.on("SIGUSR2",()=>n({exit:!0})),process.on("uncaughtException",()=>n({exit:!0}))}async listAgents(){return await this.preloadAgents(),Object.keys(this.preloadedAgents).sort()}async getAgentFile(t){return await this.preloadAgents(),this.preloadedAgents[t]}async disposeAll(){await Promise.all(Object.values(this.preloadedAgents).map(t=>t.dispose()))}async preloadAgents(){if(this.agentsAlreadyPreloaded)return;let t=await X(this.agentsDirPath)?[await Ee(this.agentsDirPath)]:await Oe(this.agentsDirPath);await Promise.all(t.map(async s=>{if(s.isFile&&je(s.ext))return this.loadAgentFromFile(s);if(s.isDirectory)return this.loadAgentFromDirectory(s)})),this.agentsAlreadyPreloaded=!0}async loadAgentFromFile(t){try{let s=new $(t.path,this.options);await s.load(),this.preloadedAgents[t.name]=s}catch(s){if(s instanceof L)return;throw s}}async loadAgentFromDirectory(t){let n=(await Oe(t.path)).find(r=>r.isFile&&r.name==="agent"&&je(r.ext));if(n)try{let r=new $(n.path,this.options);await r.load(),this.preloadedAgents[t.name]=r}catch(r){if(r instanceof L)return;throw r}}};function je(e){return!!e&&tt.includes(e)}async function Oe(e){let t=await C.readdir(e);return await Promise.all(t.map(s=>Ee(j.join(e,s))))}async function Ee(e){let t=await C.stat(e),s=t.isFile(),n=j.basename(e),r=j.extname(e);return{path:e,name:s?n.slice(0,n.length-r.length):n,ext:s?j.extname(e):void 0,isFile:s,isDirectory:t.isDirectory()}}var u=require("@google/adk"),h=require("ts-graphviz");var Pe="#0F5223",le="#69CB87",B="#cccccc",ue="#ffffff";async function U(e,t,s,n){async function r(c,i){if((0,u.isLoopAgent)(i)){n&&o(n.name,i.subAgents[0].name);let l=i.subAgents.length,p=0;for(let w of i.subAgents){await U(c,w,s,i);let d=p===l-1?i.subAgents[0]:i.subAgents[p+1];o(i.subAgents[p].name,d.name),p++}}else if((0,u.isSequentialAgent)(i)){n&&o(n.name,i.subAgents[0].name);let l=i.subAgents.length,p=0;for(let w of i.subAgents)await U(c,w,s,i),p!==l-1&&o(i.subAgents[p].name,i.subAgents[p+1].name),p++}else if((0,u.isParallelAgent)(i))for(let l of i.subAgents)await U(c,l,s,i),n&&o(n.name,l.name);else for(let l of i.subAgents)await U(c,l,s,i),o(i.name,l.name);return c}async function a(c){let i=Ce(c),l=nt(c),p=st(c),w=Z(c);if(s){for(let d of s)if(d.includes(i)){if(w){let m=new h.Subgraph(`cluster_${i}`,{label:`cluster_${i}`,style:"rounded",bgcolor:ue,fontcolor:B});e.addSubgraph(m),await r(m,t)}else e.addNode(new h.Node(i,{label:p,style:"filled,rounded",fillcolor:Pe,color:Pe,shape:l,fontcolor:B}));return}}if(w){let d=new h.Subgraph(`cluster_${i}`,{label:`cluster_${i}`,style:"rounded",bgcolor:ue,fontcolor:B});e.addSubgraph(d),await r(d,t);return}e.addNode(new h.Node(i,{label:p,style:"rounded",fillcolor:ue,color:B,shape:l,fontcolor:B}))}function o(c,i){if(s)for(let[l,p]of s){if(c===l&&i===p){e.addEdge(new h.Edge([e.node(c),e.node(i)],{color:le}));return}if(c===p&&i===l){e.addEdge(new h.Edge([e.node(c),e.node(i)],{color:le,dir:"back"}));return}}if(Z(t)){e.addEdge(new h.Edge([new h.Node(c),new h.Node(i)],{color:le}));return}e.addEdge(new h.Edge([new h.Node(c),new h.Node(i)],{arrowhead:"none",color:B}))}await a(t);for(let c of t.subAgents)await U(e,c,s,t),!Z(c)&&!Z(t)&&o(t.name,c.name);if((0,u.isLlmAgent)(t))for(let c of await t.canonicalTools())await a(c),o(t.name,Ce(c))}function Ce(e){if((0,u.isBaseAgent)(e))return(0,u.isSequentialAgent)(e)?`${e.name} (Sequential Agent)`:(0,u.isLoopAgent)(e)?`${e.name} (Loop Agent)`:(0,u.isParallelAgent)(e)?`${e.name} (Parallel Agent)`:e.name;if((0,u.isBaseTool)(e))return e.name;throw new Error(`Unsupported tool type: ${e}`)}function st(e){return(0,u.isBaseAgent)(e)?`\u{1F916} ${e.name}`:(0,u.isFunctionTool)(e)?`\u{1F527} ${e.name}`:(0,u.isAgentTool)(e)?`\u{1F916} ${e.name}`:(0,u.isBaseTool)(e)?`\u{1F527} ${e.name}`:(console.warn(`Unsupported tool type: ${typeof e}`),`\u2753 Unsupported tool type: ${typeof e}`)}function nt(e){return(0,u.isBaseAgent)(e)?"ellipse":(0,u.isFunctionTool)(e)||(0,u.isBaseTool)(e)?"box":(console.warn(`Unsupported tool type: ${typeof e}`),"cylinder")}function Z(e){return!!((0,u.isSequentialAgent)(e)||(0,u.isLoopAgent)(e)||(0,u.isParallelAgent)(e))}async function rt(e,t){let s=new h.Digraph(e.name,!0,{rankdir:"LR",bgcolor:"#333537"});return await U(s,e,t),s}async function ee(e,t){let s=await rt(e,t);return(0,h.toDot)(s)}var V=class{constructor(t){this.runnerCache={};var s,n,r,a,o,c,i;this.host=(s=t.host)!=null?s:"localhost",this.port=(n=t.port)!=null?n:8e3,this.sessionService=(r=t.sessionService)!=null?r:new y.InMemorySessionService,this.memoryService=(a=t.memoryService)!=null?a:new y.InMemoryMemoryService,this.artifactService=(o=t.artifactService)!=null?o:new y.InMemoryArtifactService,this.agentLoader=(c=t.agentLoader)!=null?c:new G(t.agentsDir),this.serveDebugUI=(i=t.serveDebugUI)!=null?i:!1,this.allowOrigins=t.allowOrigins,this.app=(0,Y.default)(),this.init()}init(){let t=this.app;this.serveDebugUI&&(t.get("/",(s,n)=>{n.redirect("/dev-ui")}),t.use("/dev-ui",Y.default.static(Te.join(__dirname,"../browser"),{setHeaders:(s,n)=>{n.endsWith(".js")&&s.setHeader("Content-Type","text/javascript")}}))),this.allowOrigins&&t.use((0,xe.default)({origin:this.allowOrigins})),t.use(Y.default.urlencoded({limit:"50mb",extended:!0})),t.use(Y.default.json({limit:"50mb"})),t.get("/list-apps",async(s,n)=>{try{let r=await this.agentLoader.listAgents();n.json(r)}catch(r){n.status(500).json({error:r.message})}}),t.get("/debug/trace/:eventId",(s,n)=>n.status(501).json({error:"Not implemented"})),t.get("/debug/trace/session/:sessionId",(s,n)=>n.status(501).json({error:"Not implemented"})),t.get("/apps/:appName/users/:userId/sessions/:sessionId/events/:eventId/graph",async(s,n)=>{try{var r=[];try{let l=s.params.appName;let p=s.params.userId;let w=s.params.sessionId;let d=s.params.eventId;let m=await this.sessionService.getSession({appName:l,userId:p,sessionId:w});if(!m){n.status(404).json({error:`Session not found: ${w}`});return}let b=m.events||[];let g=b.find(P=>P.id===d);if(!g){n.status(404).json({error:`Event not found: ${d}`});return}let R=(0,y.getFunctionCalls)(g);let _=(0,y.getFunctionResponses)(g);let E=k(r,await this.agentLoader.getAgentFile(l),!0);let oe=await E.load();if(R.length>0){let P=[];for(let ie of R)P.push([g.author,ie.name]);return n.send({dotSrc:await ee(oe,P)})}if(_.length>0){let P=[];for(let ie of _)P.push([ie.name,g.author]);return n.send({dotSrc:await ee(oe,P)})}return n.send({dotSrc:await ee(oe,[[g.author,""]])})}catch(a){var o=a,c=!0}finally{var i=D(r,o,c);i&&await i}}catch(l){n.status(500).json({error:l.message});return}}),t.get("/apps/:appName/users/:userId/sessions/:sessionId",async(s,n)=>{try{let r=s.params.appName,a=s.params.userId,o=s.params.sessionId,c=await this.sessionService.getSession({appName:r,userId:a,sessionId:o});if(!c){n.status(404).json({error:`Session not found: ${o}`});return}n.json(c)}catch(r){n.status(500).json({error:r.message})}}),t.get("/apps/:appName/users/:userId/sessions",async(s,n)=>{try{let r=s.params.appName,a=s.params.userId,o=await this.sessionService.listSessions({appName:r,userId:a});n.json(o)}catch(r){n.status(500).json({error:r.message})}}),t.post("/apps/:appName/users/:userId/sessions/:sessionId",async(s,n)=>{try{let r=s.params.appName,a=s.params.userId,o=s.params.sessionId;if(await this.sessionService.getSession({appName:r,userId:a,sessionId:o})){n.status(400).json({error:`Session already exists: ${o}`});return}let i=await this.sessionService.createSession({appName:r,userId:a,state:{},sessionId:o});n.json(i)}catch(r){n.status(500).json({error:r.message})}}),t.post("/apps/:appName/users/:userId/sessions",async(s,n)=>{try{let r=s.params.appName,a=s.params.userId,o=await this.sessionService.createSession({appName:r,userId:a});n.json(o)}catch(r){n.status(500).json({error:r.message})}}),t.delete("/apps/:appName/users/:userId/sessions/:sessionId",async(s,n)=>{try{let r=s.params.appName,a=s.params.userId,o=s.params.sessionId;if(!await this.sessionService.getSession({appName:r,userId:a,sessionId:o})){n.status(404).json({error:`Session not found: ${o}`});return}await this.sessionService.deleteSession({appName:r,userId:a,sessionId:o}),n.status(204).json({})}catch(r){n.status(500).json({error:r.message})}}),t.get("/apps/:appName/users/:userId/sessions/:sessionId/artifacts/:artifactName",async(s,n)=>{try{let r=s.params.appName,a=s.params.userId,o=s.params.sessionId,c=s.params.artifactName,i=await this.artifactService.loadArtifact({appName:r,userId:a,sessionId:o,filename:c});if(!i){n.status(404).json({error:`Artifact not found: ${c}`});return}n.json(i)}catch(r){n.status(500).json({error:r.message})}}),t.get("/apps/:appName/users/:userId/sessions/:sessionId/artifacts/:artifactName/versions/:versionId",async(s,n)=>{try{let r=s.params.appName,a=s.params.userId,o=s.params.sessionId,c=s.params.artifactName,i=s.params.versionId,l=await this.artifactService.loadArtifact({appName:r,userId:a,sessionId:o,filename:c,version:parseInt(i,10)});if(!l){n.status(404).json({error:`Artifact not found: ${c}`});return}n.json(l)}catch(r){n.status(500).json({error:r.message})}}),t.get("/apps/:appName/users/:userId/sessions/:sessionId/artifacts",async(s,n)=>{try{let r=s.params.appName,a=s.params.userId,o=s.params.sessionId,c=await this.artifactService.listArtifactKeys({appName:r,userId:a,sessionId:o});n.json(c)}catch(r){n.status(500).json({error:r.message})}}),t.get("/apps/:appName/users/:userId/sessions/:sessionId/artifacts/:artifactName/versions",async(s,n)=>{try{let r=s.params.appName,a=s.params.userId,o=s.params.sessionId,c=s.params.artifactName,i=await this.artifactService.listVersions({appName:r,userId:a,sessionId:o,filename:c});n.json(i)}catch(r){n.status(500).json({error:r.message})}}),t.delete("/apps/:appName/users/:userId/sessions/:sessionId/artifacts/:artifactName",async(s,n)=>{try{let r=s.params.appName,a=s.params.userId,o=s.params.sessionId,c=s.params.artifactName;await this.artifactService.deleteArtifact({appName:r,userId:a,sessionId:o,filename:c}),n.status(204).json({})}catch(r){n.status(500).json({error:r.message})}}),t.post("/apps/:appName/eval_sets/:evalSetId",(s,n)=>n.status(501).json({error:"Not implemented"})),t.get("/apps/:appName/eval_sets",(s,n)=>n.status(501).json({error:"Not implemented"})),t.post("/apps/:appName/eval_sets/:evalSetId/add_session",(s,n)=>n.status(501).json({error:"Not implemented"})),t.get("/apps/:appName/eval_sets/:evalSetId/evals",(s,n)=>n.status(501).json({error:"Not implemented"})),t.get("/apps/:appName/eval_sets/:evalSetId/evals/:evalCaseId",(s,n)=>n.status(501).json({error:"Not implemented"})),t.put("/apps/:appName/eval_sets/:evalSetId/evals/:evalCaseId",(s,n)=>n.status(501).json({error:"Not implemented"})),t.delete("/apps/:appName/eval_sets/:evalSetId/evals/:evalCaseId",(s,n)=>n.status(501).json({error:"Not implemented"})),t.post("/apps/:appName/eval_sets/:evalSetId/run_eval",(s,n)=>n.status(501).json({error:"Not implemented"})),t.get("/apps/:appName/eval_results/:evalResultId",(s,n)=>n.status(501).json({error:"Not implemented"})),t.get("/apps/:appName/eval_results",(s,n)=>n.status(501).json({error:"Not implemented"})),t.get("/apps/:appName/eval_metrics",(s,n)=>n.status(501).json({error:"Not implemented"})),t.post("/run",async(s,n)=>{let{appName:r,userId:a,sessionId:o,newMessage:c}=s.body;if(!await this.sessionService.getSession({appName:r,userId:a,sessionId:o})){n.status(404).json({error:`Session not found: ${o}`});return}try{var l=[];try{let b=k(l,await this.agentLoader.getAgentFile(r),!0);let g=await b.load();let R=await this.getRunner(g,r);let _=[];for await(let E of R.runAsync({userId:a,sessionId:o,newMessage:c}))_.push(E);n.json(_)}catch(p){var w=p,d=!0}finally{var m=D(l,w,d);m&&await m}}catch(b){n.status(500).json({error:b.message})}}),t.post("/run_sse",async(s,n)=>{let{appName:r,userId:a,sessionId:o,newMessage:c,streaming:i}=s.body;if(!await this.sessionService.getSession({appName:r,userId:a,sessionId:o})){n.status(404).json({error:`Session not found: ${o}`});return}try{var p=[];try{let g=k(p,await this.agentLoader.getAgentFile(r),!0);let R=await g.load();let _=await this.getRunner(R,r);n.setHeader("Cache-Control","no-cache");n.setHeader("Content-Type","text/event-stream");n.setHeader("Access-Control-Allow-Origin","*");n.setHeader("Connection","keep-alive");n.flushHeaders();for await(let E of _.runAsync({userId:a,sessionId:o,newMessage:c,runConfig:{streamingMode:i?y.StreamingMode.SSE:y.StreamingMode.NONE}}))n.write(`data: ${JSON.stringify(E)}

`);n.end()}catch(w){var d=w,m=!0}finally{var b=D(p,d,m);b&&await b}}catch(g){n.headersSent?n.end(`data: ${JSON.stringify({error:g.message})}

`):n.status(500).json({error:g.message})}})}start(){return new Promise(t=>{this.server=this.app.listen(this.port,()=>{let s=`${this.host}:${this.port}`;console.log(`
+-----------------------------------------------------------------------------+
| ADK Web Server started                                                      |
|                                                                             |
| For local testing, access at http://${s}.${"".padStart(39-s.length)}|
+-----------------------------------------------------------------------------+`),t()})})}stop(){return this.server?new Promise((t,s)=>{this.server.close(n=>{if(n){s(n);return}console.log(`
+-----------------------------------------------------------------------------+
| ADK Web Server stopped                                                      |
+-----------------------------------------------------------------------------+`),t()})}):Promise.resolve()}async getRunner(t,s){return s in this.runnerCache||(this.runnerCache[s]=new y.Runner({appName:s,agent:t,memoryService:this.memoryService,sessionService:this.sessionService,artifactService:this.artifactService})),this.runnerCache[s]}};var F=require("@google/adk"),J=f(require("path")),De=f(require("readline"));var pe=process.cwd();async function Le(e){let t=De.createInterface({input:process.stdin,output:process.stdout});return new Promise(s=>{t.question(e,n=>{t.close(),s(n)})})}async function at(e){let t=await K(J.join(pe,e.filePath));if(!t)return;t.state._time=new Date().toISOString();let s=await e.sessionService.createSession({appName:e.appName,userId:e.userId,state:t.state}),n=new F.Runner(e);for(let r of t.queries){console.log(`[user]: ${r}`);let a={userId:s.userId,sessionId:s.id,newMessage:{role:"user",parts:[{text:r}]}};for await(let o of n.runAsync(a))if(o.content&&o.content.parts){let c=o.content.parts.map(i=>i.text||"").join("");c&&console.log(`[${o.author}]: ${c}`)}}return s}async function ke(e){let t=new F.Runner({appName:e.rootAgent.name,agent:e.rootAgent,artifactService:e.artifactService,sessionService:e.sessionService,memoryService:e.memoryService});for(;;){let s=await Le("[user]: ");if(!(!s||!s.trim())){if(s==="exit")break;for await(let n of t.runAsync({userId:e.session.userId,sessionId:e.session.id,newMessage:{role:"user",parts:[{text:s}]}}))if(n.content&&n.content.parts){let r=n.content.parts.map(a=>a.text||"").join("");r&&console.log(`[${n.author}]: ${r}`)}}}}async function $e(e){var t;try{var s=[];try{let c="test_user";let i=e.artifactService||new F.InMemoryArtifactService;let l=e.sessionService||new F.InMemorySessionService;let p=e.memoryService||new F.InMemoryMemoryService;let w=k(s,new $(J.join(pe,e.agentPath)),!0);let d=await w.load();let m=await l.createSession({appName:d.name,userId:c});if(e.inputFile)m=await at({appName:d.name,userId:c,agent:d,artifactService:i,sessionService:l,memoryService:p,filePath:e.inputFile})||m;else if(e.savedSessionFile){let b=await K(e.savedSessionFile);if(b)for(let g of b.events){await l.appendEvent({session:m,event:g});let R=g.content;if(R&&((t=R.parts)!=null&&t.length)){let _=R.parts.map(E=>E.text||"").join("");_&&console.log(`[${g.author}]: ${_}`)}}await ke({rootAgent:d,artifactService:i,sessionService:l,memoryService:p,session:m})}else console.log(`Running agent ${d.name}, type exit to exit.`),await ke({rootAgent:d,artifactService:i,sessionService:l,memoryService:p,session:m});if(e.saveSession){let b=e.sessionId||await Le("Session ID to save: "),g=J.join(e.agentPath,`${b}.session.json`),R=await l.getSession({appName:m.appName,userId:m.userId,sessionId:m.id});await N(J.join(pe,g),R),console.log("Session saved to",g)}}catch(n){var r=n,a=!0}finally{var o=D(s,r,a);o&&await o}}catch(c){console.log(c)}}var te=require("child_process"),x=f(require("fs/promises")),I=f(require("path")),de=require("util");var ot=(0,de.promisify)(te.exec),it=(0,de.promisify)(te.spawn),ct=["@google/adk"];function lt(e,t){let s=new Set;for(let r of e)if(r.startsWith("--")){let a=r.split("=")[0];s.add(a)}let n=t.filter(r=>s.has(r)).sort();if(n.length)throw new Error(`The argument(s) ${n.join(", ")} conflict with ADK's automatic configuration. ADK will set these arguments automatically, so please remove them from your command.`)}async function ut(e,t){let s=await e.listAgents();for(let n of s){let r=await e.getAgentFile(n),a=I.parse(r.getFilePath()).base;await x.cp(r.getFilePath(),I.join(t,a))}}function pt(e){var c;let t=e.region?["--region",e.region]:[],s=["--source","--project","--port","--verbosity"];e.region&&s.push("--region"),e.extraGcloudArgs&&lt(e.extraGcloudArgs,s);let n=["run","deploy",e.serviceName,"--source",e.tempFolder,"--project",e.project,...t,"--port",e.port.toString(),"--verbosity",e.logLevel.toLowerCase()],r=[],a=[];if((c=e.extraGcloudArgs)!=null&&c.length)for(let i of e.extraGcloudArgs)i==="--labels"?r.push(i.slice(9)):a.push(i);let o=["created-by=adk",...r];return n.push("--labels",o.join(",")),n.push(...a),n}async function dt(e,t){let s=await Ne(e,"package.json",3),n=await K(s);if(!n||!n.dependencies)throw new Error(`No dependencies found in package.json: ${s}`);for(let a of ct)if(!(a in n.dependencies))throw new Error(`Package "${a}" is required but not found in package.json: ${s}`);let r=I.join(t,"package.json");await Promise.all([x.mkdir(I.join(t,"node_modules")),N(I.join(t,"package-lock.json"),""),N(r,{dependencies:n.dependencies})]),console.info("Creating package.json complete",r)}function gt(e){let t=e.withUi?"web":"api_server",s=[`--port=${e.port}`,"--host=0.0.0.0"];return e.logLevel&&s.push(`--log_level=${e.logLevel}`),e.allowOrigins&&s.push(`--allow_origins=${e.allowOrigins}`),e.artifactServiceUri&&s.push(`--artifact_service_uri=${e.artifactServiceUri}`),`
FROM node:lts-alpine
WORKDIR /app

# Create a non-root user
RUN adduser --disabled-password --gecos "" myuser

# Switch to the non-root user
USER myuser

# Set up environment variables - Start
ENV PATH="/home/myuser/.local/bin:$PATH"
ENV GOOGLE_GENAI_USE_VERTEXAI=1
ENV GOOGLE_CLOUD_PROJECT=${e.project}
ENV GOOGLE_CLOUD_LOCATION=${e.region}
# Set up environment variables - End

# Copy application files
COPY --chown=myuser:myuser "agents/${e.appName}/" "/app/agents/${e.appName}/"
COPY --chown=myuser:myuser "package.json" "/app/package.json"
COPY --chown=myuser:myuser "package-lock.json" "/app/package-lock.json"
COPY --chown=myuser:myuser "node_modules" "/app/node_modules"
# Copy application files

# Install Agent Deps - Start
RUN npm install @google/adk-devtools@latest
RUN npm install --production
# Install Agent Deps - End

EXPOSE ${e.port}

CMD npx adk ${t} /app/agents/${e.appName} ${s.join(" ")}`}async function Ge(e){let{stdout:t}=await ot("gcloud config get-value "+e);return t.trim()}async function mt(e,t){let s=I.join(e,"Dockerfile");await N(s,gt(t)),console.info("Creating Dockerfile complete:",s)}async function Be(e){let t=e.project||await Ge("project");if(!t||t==="(unset)")throw new Error('Project is not specified and default value for "project" is not set in gcloud config. Please specify region with --project option or set default value running "gcloud config set project YOUR_PROJECT".');e.project||(e.project=t,console.info("--project option is not provided, using default project from gcloud config:",t));let s=e.region||await Ge("run/region");if(!s)throw new Error('Region is not specified and default value for "run/region" is not set in gcloud config. Please specify region with --region option or set default value running "gcloud config set run/region YOUR_REGION".');e.region||(e.region=s,console.info("--region option is not provided, using default region from gcloud config:",s));let n=pt(e),r=new G(e.agentPath,{bundle:"any"}),a=await X(e.agentPath),o=a?I.dirname(e.agentPath):e.agentPath,c=e.appName||a?I.parse(e.agentPath).name:I.basename(e.agentPath);console.info("Starting deployment to Cloud Run..."),await q(e.tempFolder)&&(console.info("Cleaning up existing temporary files..."),await x.rm(e.tempFolder,{recursive:!0,force:!0}));try{console.info("Copying agent source files..."),await ut(r,I.join(e.tempFolder,"agents",c)),console.info("Creating package.json..."),await dt(o,e.tempFolder),console.info("Creating Dockerfile..."),await mt(e.tempFolder,{appName:c,project:e.project,region:e.region,port:e.port,withUi:e.withUi,logLevel:e.logLevel,allowOrigins:e.allowOrigins}),console.info("Deploying to Cloud Run..."),await it("gcloud",n,{stdio:"inherit"})}catch(i){console.error("\x1B[31mFailed to deploy to Cloud Run:",i.message,"\x1B[0m")}finally{console.info("Cleaning up temporary files..."),await x.rm(e.tempFolder,{recursive:!0,force:!0}),await r.disposeAll(),console.info("Temporary files cleaned up.")}}var T=f(require("path")),H=require("child_process"),Me=require("util");var v=require("@clack/prompts");var Ue=(0,Me.promisify)(H.exec),qe=process.cwd(),ft=`{
  "compilerOptions": {
    "target": "esnext",
    "module": "nodenext",
    "rootDir": "./",
    "outDir": "dist",
    "allowUnreachableCode": false,
    "allowUnusedLabels": false,
    "declaration": true,
    "declarationMap": true,
    "esModuleInterop": true,
    "exactOptionalPropertyTypes": true,
    "noEmitOnError": true,
    "noFallthroughCasesInSwitch": true,
    "noImplicitReturns": true,
    "noUncheckedIndexedAccess": true,
    "pretty": true,
    "skipLibCheck": true,
    "sourceMap": true,
    "strict": true
  }
}
`.trim(),ht=(e,t)=>`
{
  "name": "${e}",
  "version": "1.0.0",
  "description": "",
  "main": "agent.${t}",
  "scripts": {
    "web": "npx @google/adk-devtools web",
    "cli": "npx @google/adk-devtools run agent.${t}"
  },
  "keywords": [],
  "author": "",
  "license": "ISC"
}
`.trim(),vt=e=>`
import {FunctionTool, LlmAgent} from '@google/adk';
import {z} from 'zod';
import dotenv from 'dotenv';

dotenv.config();

/* Mock tool implementation */
const getCurrentTime = new FunctionTool({
  name: 'get_current_time',
  description: 'Returns the current time in a specified city.',
  parameters: z.object({
    city: z.string().describe("The name of the city for which to retrieve the current time."),
  }),
  execute: ({city}) => {
    return {status: 'success', report: \`The current time in \${ city } is 10: 30 AM\`};
  },
});

export const rootAgent = new LlmAgent({
  name: 'hello_time_agent',
  model: '${e}',
  description: 'Tells the current time in a specified city.',
  instruction: \`You are a helpful assistant that tells the current time in a city.
                Use the 'getCurrentTime' tool for this purpose.\`,
  tools: [getCurrentTime],
});
`.trim();async function wt(){if(process.env.GOOGLE_CLOUD_PROJECT)return process.env.GOOGLE_CLOUD_PROJECT;try{return(0,H.execSync)("gcloud config get-value project",{encoding:"utf-8",stdio:"pipe"}).trim()}catch{return""}}async function yt(){if(process.env.GOOGLE_CLOUD_LOCATION)return process.env.GOOGLE_CLOUD_LOCATION;try{return(0,H.execSync)("gcloud config get-value compute/region",{encoding:"utf-8",stdio:"pipe"}).trim()}catch{return""}}async function St(e,t){if(!await q(e))return await ce(e);let s=t?!0:await(0,v.select)({message:`Folder ${e} already exists. Would you like to overwrite existing folder?`,options:[{label:"Yes",value:!0},{label:"No",value:!1}]});(0,v.isCancel)(s)&&process.exit(0),s||(console.error(`Agent directory ${e} already exists.`),process.exit(0)),await be(e),await ce(e)}function It(e){let t=[];return e.apiKey&&(t.push(`GOOGLE_API_KEY=${e.apiKey}`),t.push("GOOGLE_GENAI_USE_VERTEXAI=0")),e.project&&t.push(`GOOGLE_CLOUD_PROJECT=${e.project}`),e.region&&t.push(`GOOGLE_CLOUD_LOCATION=${e.region}`),e.region&&e.project&&t.push("GOOGLE_GENAI_USE_VERTEXAI=1"),t.join(`
`)}async function At(e){let t=T.join(qe,e.agentName);await N(T.join(t,`agent.${e.language}`),vt(e.model||"gemini-2.5-flash")),await N(T.join(t,".env"),It(e)),await N(T.join(t,"package.json"),ht(e.agentName,e.language)),e.language==="ts"&&await N(T.join(t,"tsconfig.json"),ft)}async function Ke(e){let t=T.join(qe,e.agentName);if(await St(t,e.forceYes),!e.model){let n=e.forceYes?"gemini-2.5-flash":await(0,v.select)({message:"Choose a model for the root agent",options:[{label:"gemini-2.5-flash",value:"gemini-2.5-flash"},{label:"gemini-2.5-pro",value:"gemini-2.5-pro"},{label:"gemini-3-flash-preview",value:"gemini-3-flash-preview"},{label:"gemini-3-pro-preview",value:"gemini-3-pro-preview"}]});(0,v.isCancel)(n)&&process.exit(0),e.model=n}if(e.language!=="js"&&e.language!=="ts"){let n=e.forceYes?"ts":await(0,v.select)({message:"Choose a language for the agent",options:[{label:"TypeScript",value:"ts"},{label:"JavaScript",value:"js"}]});(0,v.isCancel)(n)&&process.exit(0),e.language=n}if(!e.apiKey&&!e.project){let n=e.forceYes?"googleai":await(0,v.select)({message:"Choose a backend",options:[{label:"Google AI",value:"googleai"},{label:"Vertex AI",value:"vertex"}]});if((0,v.isCancel)(n)&&process.exit(0),n==="vertex"){let r=await wt(),a=await yt(),o=e.forceYes?r:(await(0,v.text)({message:"Enter the Google Cloud Project ID",initialValue:r})).toString();(0,v.isCancel)(o)&&process.exit(0),e.project=o;let c=e.forceYes?a:await(0,v.text)({message:"Enter the Google Cloud Region",initialValue:a});(0,v.isCancel)(c)&&process.exit(0),e.region=c}else{let r=e.forceYes?"":await(0,v.text)({message:"Enter the Google API Key"});(0,v.isCancel)(r)&&process.exit(0),e.apiKey=r}}await At(e),e.language==="ts"&&await Ue("npm install typescript --save-dev",{cwd:t}),await Ue("npm install @google/adk @google/adk-devtools zod@3.25.76 dotenv",{cwd:t});let s=await Re(t);console.log(`
Created the following files in ${t}:`),s.forEach(n=>{console.log(`  - ${n}`)}),console.log(`Run 'cd ${e.agentName} && npm run web' to start the agent in a web interface`)}Ve.default.config();var bt={debug:A.LogLevel.DEBUG,info:A.LogLevel.INFO,warn:A.LogLevel.WARN,error:A.LogLevel.ERROR};function ge(e){return e.verbose?A.LogLevel.DEBUG:typeof e.log_level=="string"?bt[e.log_level.toLowerCase()]||A.LogLevel.INFO:A.LogLevel.INFO}function me(e){return se.isAbsolute(e)?e:se.join(process.cwd(),e)}function fe(e){if(e.startsWith("gs://")){let t=e.split("://")[1];return new A.GcsArtifactService(t)}throw new Error(`Unsupported artifact service URI: ${e}`)}var he=new O.Argument("[agents_dir]","Agent file or directory of agents to serve. For directory the internal structure should be agents_dir/{agentName}.js or agents_dir/{agentName}/agent.js. Agent file should has export of the rootAgent as instance of BaseAgent (e.g LlmAgent)").default(process.cwd()),Je=new O.Option("-h, --host <string>","Optional. The binding host of the server").default(Ye.hostname()),ve=new O.Option("-p, --port <number>","Optional. The port of the server").default("8000"),we=new O.Option("--allow_origins <string>","Optional. The allow origins of the server").default(""),ne=new O.Option("-v, --verbose [boolean]","Optional. The verbose level of the server").default(!1),re=new O.Option("--log_level <string>","Optional. The log level of the server").default("info"),ae=new O.Option("--artifact_service_uri <string>, Optional. The URI of the artifact service, supported URIs: gs://<bucket name> for GCS artifact service."),M=new O.Command("ADK CLI");M.command("web").description("Start ADK web server").addArgument(he).addOption(Je).addOption(ve).addOption(we).addOption(ne).addOption(re).addOption(ae).action((e,t)=>{(0,A.setLogLevel)(ge(t)),new V({agentsDir:me(e),host:t.host,port:parseInt(t.port,10),serveDebugUI:!0,allowOrigins:t.allow_origins,artifactService:t.artifact_service_uri?fe(t.artifact_service_uri):void 0}).start()});M.command("api_server").description("Start ADK API server").addArgument(he).addOption(Je).addOption(ve).addOption(we).addOption(ne).addOption(re).addOption(ae).action((e,t)=>{(0,A.setLogLevel)(ge(t)),new V({agentsDir:me(e),host:t.host,port:parseInt(t.port,10),serveDebugUI:!1,allowOrigins:t.allow_origins,artifactService:t.artifact_service_uri?fe(t.artifact_service_uri):void 0}).start()});M.command("create").description("Creates a new agent").argument("[agent]","Name to give the new agent","adk_agent").option("-y, --yes","Optional. Skip confirmation prompts.").option("--model <string>","Optional. THe model used for the root_agent").option("--api_key <string>","Optional. The API Key needed to access the model, e.g. Google AI API Key.").option("--project <string>","Optional. The Google Cloud Project for using VertexAI as backend.").option("--region <string>","Optional. The Google Cloud Region for using VertexAI as backend.").option("--language <string>","Optional. Either ts or js as the language to output.").action((e,t)=>{Ke({agentName:e,forceYes:!!t.yes,model:t.model,apiKey:t.api_key,project:t.project,region:t.region,language:t.language})});M.command("run").description("Runs agent").argument("<agent>","Agent file path (.js or .ts)").option("--save_session [boolean]","Optional. Whether to save the session to a json file on exit.",!1).option("--session_id <string>","Optional. The session ID to save the session to on exit when --save_session is set to true. User will be prompted to enter a session ID if not set.").option("--replay <string>","The json file that contains the initial state of the session and user queries. A new session will be created using this state. And user queries are run against the newly created session. Users cannot continue to interact with the agent.").option("--resume <string>","The json file that contains a previously saved session (by --save_session option). The previous session will be re-displayed. And user can continue to interact with the agent.").addOption(ne).addOption(re).addOption(ae).action((e,t)=>{(0,A.setLogLevel)(ge(t)),$e({agentPath:e,inputFile:t.replay,savedSessionFile:t.resume,saveSession:!!t.save_session,sessionId:t.session_id,artifactService:t.artifact_service_uri?fe(t.artifact_service_uri):void 0})});var Rt=M.command("deploy").description("Deploy agent").allowUnknownOption().allowExcessArguments();Rt.command("cloud_run").addArgument(he).addOption(ve).option("--project [string]","Optional. Google Cloud project to deploy the agent. If not set, default project from gcloud config is used").option("--region [string]","Optional. Google Cloud region to deploy the agent. If not set, default run/region from gcloud config is used").option("--service_name [string]",'Optional. The service name to use in Cloud Run. Default: "adk-default-service-name"',"adk-default-service-name").option("--temp_folder [string]","Optional. Temp folder for the generated Cloud Run source files (default: a timestamped folder in the system temp directory).",z("cloud_run_deploy_src")).option("--adk_version [string]","Optional. ADK version to use in the Cloud Run service. If not set, default to the latest version available on npm","latest").option("--with_ui [boolean]","Optional. Deploy ADK Web UI if set. (default: deploy ADK API server only)",!1).addOption(we).addOption(ne).addOption(re).addOption(ae).action((e,t)=>{let s=[];for(let n of process.argv.slice(5)){let r=n.replace(/^-+/,"");r.includes("=")&&(r=r.split("=")[0]),!(r in t)&&s.push(n)}Be({agentPath:me(e),project:t.project,region:t.region,serviceName:t.service_name,tempFolder:t.temp_folder,port:parseInt(t.port,10),withUi:!!t.with_ui,logLevel:t.log_level,adkVersion:t.adk_version,allowOrigins:t.allow_origins,extraGcloudArgs:s,artifactServiceUri:t.artifact_service_uri})});M.parse(process.argv);
/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
